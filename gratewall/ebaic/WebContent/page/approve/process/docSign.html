<!DOCTYPE html PUBLIC>
<html>
<head>
	<title>文件签名</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-COMPATIBLE" content="IE=edge;chrome=1" />
<script type="text/javascript" src="../../../static/lib/jquery-1.8.3.js"></script> 	
<script src="../../../static/lib/JAZZ-UI/lib/jazz-all.js" type="text/javascript"></script>
<link href="../../../static/lib/JAZZ-UI/lib/themes/approve/jazz-all.css" rel="stylesheet" type="text/css" />
<link href="../../../static/css/approvalCommon.css" rel="stylesheet" type="text/css" />
</head>
<body>
	<h2>文件签名</h2>
	<div>
		<form name="SignForm" onsubmit='return false;'>
			<div>签名人 : <select id="UserList" name="UserList"></select> </div><!-- 
			<div>选择口令 : <input type="password" name="pwd1" id="UserPwd" size="16" maxlength="16">（可选）</div> -->
			<div>文书哈希码:<input type="text" name="hashcode" id="hashcode"/></div>
			<div>文书路径:<input type="text" name="filePath" id="filePath"/></div>
			<button onclick='doSign()'>签名</button>
		</form>
	</div>
	
	
<script id=clienteventhandlersjs language=javascript>
$(function(){
	
	SetUserCertList("SignForm.UserList");
	AddOnLoadEvent($onLoadFunc);
	
	//生成文书并且返回哈希码
	getFileHashcode();
	
});


function getParameter(name){
	var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)"); 
	var r = window.location.search.substr(1).match(reg); 
	if (r!=null) { 
	   return unescape(r[2]); 
	} 
	return null; 
}

function getFileHashcode(){
	var gid = getParameter('gid');
	var url="../../../approve/process/buildDocHash.do";
	$.ajax({
		url:url,
		data:{
			gid:gid
		},
		type:'post',
		dataTyoe:'json',
		success:function(response){
			if(response!=null){
				var hashCode = response.hashCode;
				var filePath = response.filePath;
				if(hashCode!=null){
					$("#hashcode").val(hashCode);
				}
				if(filePath!=null){
					$("#filePath").val(filePath);
				}else{
					alert("连接服务器失败，请稍后再试！");
					return false;
				}
				
			}
		},
		error:function(e){
			alert('连接服务器失败，请稍后重试。');;
		}
	});
}

function doSign(){
	var filePath = $('#filePath').val();
	// 初始化
	var hashCode = $("input[name='hashcode']").val();
	// 客户端签名
	var UserSignedData = doClientSign(hashCode);
	// 服务器端签名
	doServerSign(filePath, UserSignedData);
	// 禁止表单提交
	return false;
}


/**
 * 执行客户端登录。
 */
function doClientSign(hashCode){
	var strCertID = SignForm.UserList.value;
	if(!strCertID){
		$("#UserSignedData").val('');
		alert('请插入证书。');
		return ;
	}
	var UserSignedData = SignByP7(strCertID,hashCode);
	return UserSignedData;
}
/**
 * 执行服务器端登录。
 */
function doServerSign(filePath, UserSignedData){
	var gid = getParameter('gid');
	$.ajax({
		url: '../../../approve/process/signData.do',
		dataType:'json',
		data:{
			filePath : filePath,
			UserSignedData : UserSignedData,
			gid:gid
		},
		type:'post',
		success:function(resp){
			if(resp){
				if(resp.result=='success'){
					window.returnValue = "success";
					window.close();
				}
				if(resp.error){
					alert(resp.error);
				}
			}
		},
		error:function(e){
			alert('连接服务器失败，请稍后重试。');;
		}
	});
	return false;
}

</SCRIPT>
<SCRIPT language=JavaScript src="../../../demo/bjca/date.js"></SCRIPT>
<SCRIPT type="text/javascript" src="../../../demo/bjca/XTXSuite.js"></SCRIPT>
</body>
</html>