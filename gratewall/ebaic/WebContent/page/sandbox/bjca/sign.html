<!DOCTYPE html PUBLIC>
<html>
<head>
	<title>文件签名</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-COMPATIBLE" content="IE=edge;chrome=1" />
	<SCRIPT language=JavaScript src="jquery-1.8.3.js"></SCRIPT>	
</head>
<body>
	<h2>文件签名</h2>
	<div>
		<form name="SignForm" onsubmit='return false;'>
			<div>fileid：<input type='text' name='fileid' id="fileid" /></div>
			<div>签名人 : <select id="UserList" name="UserList"></select> </div><!-- 
			<div>选择口令 : <input type="password" name="pwd1" id="UserPwd" size="16" maxlength="16">（可选）</div> -->
			<button onclick='doSign()'>签名</button>
		</form>
	</div>
<SCRIPT ID=clientEventHandlersJS LANGUAGE=javascript>
$(function(){
	SetUserCertList("SignForm.UserList");
	AddOnLoadEvent($onLoadFunc);
});
function doSign(){
	var fileid = $("input[name='fileid']").val();
	// 初始化
	var hashCode = initSign(fileid);
	// 客户端签名
	var UserSignedData = doClientSign(hashCode);
	// 服务器端签名
	doServerSign(fileid, UserSignedData);
	// 禁止表单提交
	return false;
}
/**
 * 页面初始化。
 */
function initSign(fileid){
	var hashCode = '';
	$.ajax({
		url: '../../../bjca/service.do?m=preSign',
		dataType:'json',
		data:{fileid:fileid},
		async: false,
		type:'post',
		success:function(resp){
			if(resp){
				if(resp.hashCode){
					hashCode = resp.hashCode;
				}
			}
		},
		error:function(e){
			alert('连接服务器失败，请稍后重试。');;
		}
	});
	return hashCode;
}
/**
 * 执行客户端登录。
 */
function doClientSign(hashCode){
	var strCertID = SignForm.UserList.value;
	if(!strCertID){
		$("#UserSignedData").val('');
		alert('请插入证书。');
		return ;
	}
	var UserSignedData = SignByP7(strCertID,hashCode);
	return UserSignedData;
}
/**
 * 执行服务器端登录。
 */
function doServerSign(UserSignedData){
	$.ajax({
		url: '../../../bjca/service.do?m=sign',
		dataType:'json',
		data:{
			//fileid : fileid,
			UserSignedData : UserSignedData
		},
		type:'post',
		success:function(resp){
			if(resp){
				if(resp.result=='success'){
					alert('登录成功。');
					return ;
				}
				if(resp.error){
					alert(resp.error);
				}
			}
		},
		error:function(e){
			alert('连接服务器失败，请稍后重试。');;
		}
	});
	return false;
}

</SCRIPT>

<SCRIPT language=JavaScript src="date.js"></SCRIPT>
<SCRIPT type="text/javascript" src="XTXSuite.js"></SCRIPT>
</body>
</html>