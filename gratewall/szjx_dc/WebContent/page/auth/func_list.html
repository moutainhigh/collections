<!DOCTYPE html PUBLIC>
<html>
<head>
<title></title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="../../static/script/jazz.js" type="text/javascript"></script>
<script>

	var setting = {
		data: {
			simpleData: {
				enable: true,
				idKey: "id",
				pIdKey: "pid"
			}
		},
		check: { 
            enable: true, 
            chkboxType:{ "Y":'s', "N":'s'} 
        }, 
		callback: {
			onClick: treeOnClick
		}
	};
	
	var gnId, //当前选中的功能ID
		gnMc, //当前选中的功能名称
		sjgnId, //当前选中功能的上级功能ID
		sjgnMc; //当前选中功能的上级功能名称
	function treeOnClick(event, treeId, treeNode){
		clearForm();
		gnId = treeNode.id;
		gnMc = gnId=="0"? "" : treeNode.name ;
		var pnode = treeNode.getParentNode();
		sjgnId = pnode.id;
		sjgnMc = sjgnId=="0"? "无" : pnode.name;
		
		$('#formpanel').formpanel('reset');
		$('#formpanel').formpanel('option', 'dataurl', rootPath+'/auth/funcDetail.do?gnId='+gnId);
		$('#formpanel').formpanel('reload', null, function(){
			$("#sjgnMc").textfield("setValue", sjgnMc);			
		});
		
		$('#urlGrid').gridpanel('option', 'dataurl', rootPath+'/auth/queryFuncUrl.do?gnId='+gnId);
		$('#urlGrid').gridpanel('reload');
		
		$('#zjGrid').gridpanel('option', 'dataurl', rootPath+'/auth/queryFuncZj.do?gnId='+gnId);
		$('#zjGrid').gridpanel('reload');
	}
	
	var tree;
	$(document).ready(function(){
		refreshFuncTree();
	});
	
	function urlDatarender(event,obj) {
		var data = obj.data;
		for(var i=0;i<data.length;i++){
			var htm = '<a href="javascript:void(0);" onclick="editUrl(\''+data[i]["urlId"]+'\')">'
				+ "编辑" + '</a>';
			data[i]["edit"] = htm; 
		}
		return data;
	}
	
	var win; //弹出窗口
	
	function editUrl(urlId) {
		 var frameurl = 'func_url_edit.html?urlId='+urlId;
		 popUrlWin(frameurl);
	}
	
	function addUrl(){
		if(gnId==null){
			jazz.warn("请选择功能");
			return;
		}
		var frameurl = 'func_url_edit.html?gnId='+gnId;
		popUrlWin(frameurl);
	}
	
	function popUrlWin(frameurl){
		win = jazz.widget({
   	     	vtype: 'window',
   	     	frameurl: frameurl,
  			name: 'win',
  	    	title: 'URL资源',
  	    	titlealign: 'center',
  	    	titledisplay: true,
  	        width: 600,
  	        height: 350,
  	        modal:true,
  	        visible: true,
  	      	resizable: true
   		});
	}
	
	
	function refreshAll(){
		$('#gridpanel').gridpanel('reload');
		refreshFuncTree();
		$('#urlGrid').gridpanel('option', 'dataurl',rootPath+'/auth/queryFuncUrl.do');
		$('#urlGrid').gridpanel('reload');
		$('#zjGrid').gridpanel('option', 'dataurl', rootPath+'/auth/queryFuncZj.do');
		$('#zjGrid').gridpanel('reload');
	}
	
	function refreshFuncTree(){
		gnId='', gnMc='',sjgnId='',sjgnMc='';
		var params = {
			url : rootPath+'/auth/queryFuncTree.do',
			callback : function(data, r, res) { 
				var data = data["data"];
				tree = $.fn.zTree.init($("#funcTree"), setting, data);
				tree.expandAll(true);
			}
		}
		$.DataAdapter.submit(params);
	}
	
	function refreshUrl(){
		$('#urlGrid').gridpanel('reload');
	}
	
	function editFunc(event, rowdata){
		var gnId = rowdata.gnId;
		$("#sjgnMc").textfield("setValue", selectedGnMc);
		$('#formpanel').formpanel('option', 'dataurl',rootPath+'/auth/funcDetail.do?gnId='+gnId);
		$('#formpanel').formpanel('reload');
	}
	
	function saveFunc() {
		var params = {
			url : rootPath+'/auth/saveFunc.do',
			components : [ 'formpanel' ],
			callback : function(data, r, res) { 
				if(res.getAttr("back")=='success'){
					jazz.info("保存成功");
					refreshAll();
				}else{
					$('#sfcd').comboxfield("setValue","1");
					jazz.warn("该功能下有菜单节点，因此该功能也必须为菜单节点");
					refreshAll();
				}
			}
		};
		$.DataAdapter.submit(params);
	}
	
	function clearForm(){
		$('#gnId').hiddenfield("setValue", "");
		$('#gnMc').textfield("setValue", "");
		$('#url').textfield("setValue", "");
	}
	
	function addFunc(){
		clearForm();
		$("#sjgnId").hiddenfield("setValue", gnId);
		$("#sjgnMc").textfield("setValue", gnMc);
	}
	
	function deleteFunc(){
		var selectedData = tree.getCheckedNodes(true);
		if(selectedData==null || selectedData.length==0){
			jazz.warn("请选择要删除的功能");
			return;
		}
		var funcIds = new Array();
		$.each(selectedData, function(i, n){
			funcIds.push(n.id);
		});
		var funcIdsStr = funcIds.join(","); 
		jazz.confirm("确定删除所选节点？", function(){
			var params = {
				url : rootPath+'/auth/deleteFunc.do',
				params: {
					funcIdsStr : funcIdsStr
				},
				callback : function(data, r, res) { 
					jazz.info("删除成功");
					clearForm();
					refreshAll();
				}
			}
			$.DataAdapter.submit(params);
		}, function(){})
	}
	
	
	function deleteUrl(){
		var selectedData = $("#urlGrid").gridpanel("getSelection");
		if(selectedData==null || selectedData.length==0){
			jazz.warn("请选择数据");
			return ;
		}		
		jazz.confirm("确定删除所选记录？", function(){
			var params = {
				url : rootPath+'/auth/deleteFuncUrl.do',
				components: ['urlGrid'],
				callback : function(data, r, res) { 
					jazz.info("删除成功");
					refreshUrl();
				}
			}
			$.DataAdapter.submit(params);
		}, function(){})
	}
	
	function zjDatarender(event,obj) {
		var data = obj.data;
		for(var i=0;i<data.length;i++){
			var htm = '<a href="javascript:void(0);" onclick="editZj(\''+data[i]["zjId"]+'\')">'
				+ "编辑" + '</a>';
			data[i]["edit"] = htm; 
		}
		return data;
	}
	
	function editZj(zjId) {
		 var frameurl = 'func_zj_edit.html?zjId='+zjId;
		 popZjWin(frameurl);
	}
	
	function addZj(){
		if(gnId==null){
			jazz.warn("请选择功能");
			return;
		}
		var frameurl = 'func_zj_edit.html?gnId='+gnId;
		popZjWin(frameurl);
	}
	
	function popZjWin(frameurl){
		win = jazz.widget({
  	     	vtype: 'window',
  	     	frameurl: frameurl,
 			name: 'win',
 	    	title: '组件资源',
 	    	titlealign: 'center',
 	    	titledisplay: true,
 	        width: 500,
 	        height: 300,
 	        modal:true,
 	        visible: true,
 	      	resizable: true
  		});
	}
	
	function refreshZj(){
		$('#zjGrid').gridpanel('reload');
	}
	
	function deleteZj(){
		var selectedData = $("#zjGrid").gridpanel("getSelection");
		if(selectedData==null || selectedData.length==0){
			jazz.warn("请选择数据");
			return ;
		}		
		jazz.confirm("确定删除所选记录？", function(){
			var params = {
				url : rootPath+'/auth/deleteFuncZj.do',
				components: ['zjGrid'],
				callback : function(data, r, res) { 
					jazz.info("删除成功");
					refreshZj();
				}
			}
			$.DataAdapter.submit(params);
		}, function(){})
	}
	
	function publish(){
		jazz.confirm("是否将所有用户角色权限数据重新更新到缓存？", function(){
		var params = {
			url : rootPath+'/auth/publishFunc.do',
			callback : function(data, r, res) { 
				if (res.getAttr("back") == 'success'){
					jazz.info("更新成功");
				} else {
					jazz.info("未开启缓存");
				}
			}
		};
		$.DataAdapter.submit(params);
		}, function(){})
	}
</script>
</head>
<body>
	<div id="table" vtype="panel" layout="column" showborder="false" 
			layoutconfig="{columnwidth: ['25%','*']}"> 
        <div id="demo" >
        	<div id="toolbar" name="toolbar" vtype="toolbar" align="left">
					<div id="btn1" name="btn1" vtype="button" text="新增"
						icon="../../../style/default/images/save.png" click="addFunc()"></div>
					<div id="btn2" name="btn2" vtype="button" text="删除"
						icon="../../../style/default/images/fh.png" click="deleteFunc()"></div>
				</div>
			<div id="funcTree" name="funcTree" class="ztree"  ></div>
		</div>
    	
    	<div >
	   		<div id="formpanel" name="formpanel" vtype="formpanel" showborder="false" titledisplay="true" title="功能信息"
				width="100%" layout="table" layoutconfig="{cols:2, columnwidth: ['50%','*']}">
				
				<div name='gnId' id="gnId"  vtype="hiddenfield" label="功能ID" labelAlign="right" ></div>
				<div name='gnMc' id="gnMc" vtype="textfield" label="功能名称" labelAlign="right"
					rule="must" width="350"></div>
				<div name='sjgnMc' id="sjgnMc" vtype="textfield" label="上级功能" labelAlign="right" 
					readonly=true width="350" defaultvalue="无"></div>
				<div name='sjgnId' id="sjgnId" vtype="hiddenfield" label="上级功能ID" 
					labelAlign="right" ></div>
				<div id='sfcd' name='sfcd' vtype="comboxfield" label="是否菜单"
					labelAlign="right" rule="must" width="350"
					dataurl='[{"text":"是","value":"1"},{"text":"否","value":"0"}]'></div>
				<div name='url' id="url" vtype="textfield" label="URL"
					labelAlign="right"  width="350" ></div>
				<div name='xh' id="xh" vtype="textfield" label="序号" labelAlign="right"
					rule="" width="350"></div> 
				<div id="toolbar" name="toolbar" vtype="toolbar" align="center">
					<div id="btn1" name="btn1" vtype="button" text="保存"
						icon="../../../style/default/images/save.png" click="saveFunc()"></div>
					<div id="btn2" name="btn2" vtype="button" text="重置"
						icon="../../../style/default/images/fh.png" click="clearForm()"></div>
				</div>
			</div>
			
   			<div vtype="gridpanel" name="urlGrid" id="urlGrid"  datarender="urlDatarender"
				titledisplay="true" title="URL资源列表" dataurl="" showborder="false">
				<div name="toolbar" vtype="toolbar">
					<div id="btn1" name="btn1" vtype="button" text="新增"
							icon="../../../style/default/images/save.png" click="addUrl()"></div>
					<div name="delete_button" vtype="button" text="删除"
						icon="../query/queryssuo.png" onClick="deleteUrl();"></div>
					<div name="publish_button" vtype="button" text="更新缓存"
						icon="../query/queryssuo.png" onClick="publish();"></div>
				</div>
				<!-- 表头 -->
				<div vtype="gridcolumn" name="grid_column" width="100%">
					<div>
						<!-- 单行表头 -->
						<div name='urlId' text="url ID"  textalign="center" isshowcolumn=false width='0%'></div>
						<div name='urlMc' text="URL名称" textalign="center" width='38%' ></div>
						<div name='url' text="URL" textalign="left" width='52%' ></div>
						<div name='edit' text="编辑" textalign="center" width='10%'></div>
					</div>
				</div>
				<!-- 表格 -->
				<!-- ../../grid/reg3.json -->
				<div vtype="gridtable" name="grid_table" rowdblclick="rowdblclick()"></div>
				<!-- 分页 -->
		
				<div vtype="paginator" name="grid_paginator" theme="2" pagerows="5"></div>
			</div>
		
			<div vtype="gridpanel" name="zjGrid" id="zjGrid"  datarender="zjDatarender"
				titledisplay="true" title="组件资源列表" dataurl="" showborder="false">
				<div name="toolbar" vtype="toolbar">
					<div id="btn1" name="btn1" vtype="button" text="新增"
							icon="../../../style/default/images/save.png" click="addZj()"></div>
					<div name="delete_button" vtype="button" text="删除"
						icon="../query/queryssuo.png" onClick="deleteZj();"></div>
				</div>
				<!-- 表头 -->
				<div vtype="gridcolumn" name="grid_column" width="100%">
					<div>
						<!-- 单行表头 -->
						<div name='zjId' text="url ID"  textalign="center" isshowcolumn=false width='0%'></div>
						<div name='zjMc' text="组件名称" textalign="center" width='38%' ></div>
						<div name='zjCode' id=""gnMc text="组件码" textalign="center" width='52%'  ></div>
						<div name='edit' text="编辑" textalign="center" width='10%'></div>
					</div>
				</div>
				<!-- 表格 -->
				<!-- ../../grid/reg3.json -->
				<div vtype="gridtable" name="grid_table" rowdblclick="rowdblclick()"></div>
				<!-- 分页 -->
		
				<div vtype="paginator" name="grid_paginator" theme="2" pagerows="5"></div>
			</div>
   		</div>
    </div>

</body>
</html>