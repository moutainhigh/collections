(function($){$.widget("jazz.icon",$.jazz.panel,{options:{vtype:"icon",scrolltime:500,activeindex:0,iscontroller:true,isshowpaginator:true,theme:0,dataurl:null,dataurlparams:null,paramicons:{width:140,height:145},rows:2,cols:-1,iconrender:null,click:null},_create:function(){this._super();this.innerPanel=$('<div style="width: 100%; height: 100%"></div>').appendTo(this.content);this.paginator=$("<div></div>")},_init:function(){this._super();this.content.css("overflow","hidden");this.paramIconData=[];this.contentWidth=this.content.width();this.contentHeight=this.content.height();this._build(this.innerPanel);this._bindDrag(this.innerPanel);if(this.options.iscontroller&&this.options.isshowpaginator){this._bindPaginator(this.innerPanel)}},_ajax:function(){var params={url:this.options.dataurl,params:this.options.dataurlparams,callback:this._callback};$.DataAdapter.submit(params,this)},_callback:function(data,sourceThis){var jsonData=null;var $this=null;if(data=="1"){jsonData=this.options.data;$this=this}else{jsonData=data;$this=sourceThis}var icondata=jsonData.data;if(jsonData!=null&&icondata){var theme=$this.options.theme;var k=0;if(theme=="2"){var gHeight=0,rows=$this.options.rows;var innerHeight=$this.innerPanel.height();var all=$this.options.paramicons.width*icondata.length;if(all>$this.innerPanel.width()&&innerHeight>190&&rows==1){$this.options.rows=2;rows=2}gHeight=parseInt(innerHeight/parseInt($this.options.rows))-1;var paramicons=$this.options.paramicons;var iconLiObject=paramicons.iconLiObject=[];$.each(icondata,function(i,obj){var li=$('<li class="jazz-iconLi2" index="'+k+'"></li>');li.css({height:gHeight});var imgClass="";if(obj.count=="0"||obj.count==undefined){imgClass="";obj.count=""}else{imgClass="s-icon-img"}li.append('<span id="img_'+obj.id+'" class="'+imgClass+'">'+obj.count+"</span>");li.append('<div><span class="icon2" style="background: url('+obj.imageurl+')"></span><div class="text">'+obj.label+"</div></div>");var c=li.children("div");c.css("top",parseInt((li.height()-100)/2)+5);li.hover(function(){c.children("span").css("background",'url("'+obj.imageurl3+'")');c.children("div").addClass("jazz-icon-text2")},function(){c.children("span").css("background",'url("'+obj.imageurl+'")');c.children("div").removeClass("jazz-icon-text2")});if(i===0){paramicons.height=li.height()}iconLiObject.push(li);$this.paramIconData[i]=obj;k+=1})}else{var gHeight=0,gWidth=0;var rows=$this.options.rows,cols=$this.options.cols;var innerHeight=$this.innerPanel.height();gHeight=parseInt(innerHeight/parseInt(rows))-2;if(cols!=-1){var innerWidth=$this.innerPanel.width();gWidth=parseInt(innerWidth/parseInt(cols))-0}var paramicons=$this.options.paramicons;var iconLiObject=paramicons.iconLiObject=[];$.each(icondata,function(i,obj){var li=$('<li class="jazz-iconLi2" index="'+k+'"></li>');li.css({height:gHeight});if(cols!=-1){li.css({width:gWidth})}var imgClass="";if(obj.count=="0"||obj.count==undefined){imgClass="";obj.count=""}else{imgClass="s-icon-img"}li.append('<span id="img_'+obj.id+'" class="'+imgClass+'">'+obj.count+"</span>");var iconrender=$this.options.iconrender;var flag=true;if($.isFunction(iconrender)){var str=iconrender.call(this,li,obj);li.append(str);flag=false}else{li.append('<div><span class="icon2" style="background: url('+obj.imageurl+')"></span><div class="text">'+obj.label+"</div></div>")}if(flag){var c=li.children("div");c.css("top",parseInt((li.height()-100)/2)+5);li.hover(function(){c.children("span").css("background",'url("'+obj.imageurl3+'")');c.children("div").addClass("jazz-icon-text2")},function(){c.children("span").css("background",'url("'+obj.imageurl+'")');c.children("div").removeClass("jazz-icon-text2")})}if(i===0){paramicons.width=li.width();paramicons.height=li.height()}iconLiObject.push(li);$this.paramIconData[i]=obj;k+=1})}$this.iconallnumber=k;var innerPanel=$this.innerPanel;$this._buildPage(innerPanel,$this.iconallnumber);$this.ul=innerPanel.children("ul");$this._bindIconEvent($this.ul);if($this.options.iscontroller){$this._buildButton(innerPanel,$this.ul.size())}$this._updatePosition(innerPanel)}},_build:function(innerPanel){this.iconallnumber=0;if(this.options.data){this._callback("1")}else{if(this.options.dataurl){this._ajax()}}},_buildPage:function(innerPanel,k){var navBarHeight=0;var gH=this.options.paramicons.height;var gW=this.options.paramicons.width;var rows=Math.floor((this.contentHeight-navBarHeight)/gH);var cols=Math.floor(this.contentWidth/gW);rows=this.options.rows;gH=parseInt(innerPanel.height()/parseInt(rows))-1;var perIconNum=rows*cols;if(perIconNum==0){perIconNum=1}var pageNumber=Math.ceil(k/perIconNum);$.extend(this.options.paramicons,{rows:rows,cols:rows,pageNumber:pageNumber});for(var n=0;n<pageNumber;n++){var ul=$('<ul class="jazz-iconUl currDesktop"></ul>').appendTo(innerPanel);for(var j=n*perIconNum;j<(n+1)*perIconNum;j++){ul.append(this.options.paramicons.iconLiObject[j])}}if(this.options.iscontroller&&this.options.isshowpaginator){this._paginator(k,perIconNum)}},_paginator:function(total,rows){var width=this.contentWidth;var pagenum=Math.ceil(total/rows);var p=$('<div style="height: 20px;"></div>').appendTo(this.paginator);for(var i=0,len=pagenum;i<len;i++){p.append('<span class="jazz-icon-item" index="'+i+'"></span>')}var w=(width-pagenum*20)/2-5;p.css({"padding-left":w});p.outerWidth(width)},_updatePosition:function(innerPanel){var w=this.contentWidth,h=this.content.height(),$this=this,ulNumber=this.ul.size();this.moveWidth=w;innerPanel.css({width:((w)*ulNumber),height:h});innerPanel.children("ul").css({width:w,height:h,"margin-right":0});if(this.options.isshowpaginator){this.paginator.appendTo(this.content).css({position:"absolute",left:"0",bottom:"0",padding:"0"})}this.ul.each(function(){$this._iconsArrange($(this))});$this._panelMove(innerPanel,$this.ul,w,$this.options.activeindex)},_bindDrag:function(innerPanel){var $this=this;var dxStart,dxEnd;innerPanel.draggable({axis:"x",start:function(event,ui){$(this).css("cursor","move");beginTime=new Date().getTime();dxStart=event.pageX},stop:function(event,ui){var $ul=$this.ul;$(this).css("cursor","inherit");dxEnd=event.pageX;var dxCha=dxEnd-dxStart,currDesktop=$(this).find("ul.currDesktop"),deskIndex=$ul.index(currDesktop);var moveWidth=$this.contentWidth;if(dxCha<-150&&deskIndex<($ul.size()-1)){$this._panelMove($(this),$ul,moveWidth,deskIndex+1)}else{if(dxCha>150&&deskIndex>0){$this._panelMove($(this),$ul,moveWidth,deskIndex-1)}else{$(this).animate({left:-(deskIndex)*moveWidth},$this.options.scrolltime)}}}})},_bindIconEvent:function(ul){var $this=this;this.ul.children("li").on("click",function(e,i){$this._trigger("click",e,$this.paramIconData[$(this).attr("index")])})},_bindPaginator:function(innerPanel){var $this=this;$.each($this.paginator.find(".jazz-icon-item"),function(i){$(this).off("click.paicon").on("click.paicon",function(){$this._panelMove(innerPanel,$this.ul,$this.contentWidth,i)})})},_panelMove:function(innerPanel,ul,moveWidth,nextIndex){var $this=this;innerPanel.stop().animate({left:-(nextIndex)*moveWidth},$this.options.scrolltime,function(){ul.removeClass("currDesktop").eq(nextIndex).addClass("currDesktop");if($this.options.isshowpaginator){$.each($this.paginator.find(".jazz-icon-item"),function(i){if(nextIndex==i){$(this).addClass("jazz-icon-item-current")}else{$(this).removeClass("jazz-icon-item-current")}})}if($this.options.iscontroller){if(nextIndex>0){$this.leftButton.addClass("jazz-iconpanel-leftbtn")}else{$this.leftButton.removeClass("jazz-iconpanel-leftbtn")}if(nextIndex<ul.size()-1){$this.rightButton.addClass("jazz-iconpanel-rightbtn")}else{$this.rightButton.removeClass("jazz-iconpanel-rightbtn")}}});this.options.activeindex=nextIndex},_iconsArrange:function(ul){var $ul=ul;var navBarHeight=0,iconNum=$ul.find("li").size();$ul.data("iconNum",iconNum);var gH=this.options.paramicons.height;var gW=this.options.paramicons.width;gH=parseInt(this.innerPanel.height()/parseInt(this.options.rows))-1;var rows=Math.floor((this.contentHeight-navBarHeight)/gH);var cols=Math.floor(this.contentWidth/gW);var curcol=0,currow=0;var mW=0;mH=0;if(this.options.theme===1){mW=30;mH=20}$ul.find("li").css({position:"absolute",margin:0,left:function(index,value){var v=(index-cols*currow)*gW+mW;if((index+1)%cols==0){currow=currow+1}return v},top:function(index,value){var v=curcol*gH+mH;if((index+1)%cols==0){curcol=curcol+1}return v}})},_buildButton:function(innerPanel,number){var $this=this;this.leftButton=$('<a href="javascript:void(0);" target="_self"></a>').appendTo(innerPanel.parent());this.rightButton=$('<a href="javascript:void(0);" target="_self"></a>').appendTo(innerPanel.parent());this.leftButton.on("click.icon",function(){if($this.options.activeindex>0){$this._panelMove(innerPanel,$this.ul,$this.contentWidth,$this.options.activeindex-1)}});this.rightButton.on("click.icon",function(){if($this.options.activeindex<$this.ul.size()-1){$this._panelMove(innerPanel,$this.ul,$this.contentWidth,$this.options.activeindex+1)}else{$this._panelMove(innerPanel,$this.ul,$this.contentWidth,0)}});innerPanel.parent().hover(function(){if($this.options.activeindex>0){$this.leftButton.addClass("jazz-iconpanel-leftbtn")}$this.rightButton.addClass("jazz-iconpanel-rightbtn")},function(){$this.leftButton.removeClass("jazz-iconpanel-leftbtn");$this.rightButton.removeClass("jazz-iconpanel-rightbtn")})},loadData:function(url,params,flag){if(!url){if(this.options.dataurl!=null){if(!!params){this.options.params=params}this.innerPanel.children().remove();if(this.options.isshowpaginator){this.paginator.remove();this.paginator=$("<div></div>")}this._build(this.innerPanel);this._bindDrag(this.innerPanel);if(this.options.isshowpaginator){this._bindPaginator(this.innerPanel)}}}else{this.innerPanel.children().remove();if(this.options.isshowpaginator){this.paginator.remove();this.paginator=$("<div></div>")}if(flag=="static"){this.options.data=url}else{if(!!url){this.options.dataurl=url;this.options.data=null}if(!!params){this.options.params=params}}this._build(this.innerPanel);this._bindDrag(this.innerPanel);if(this.options.isshowpaginator){this._bindPaginator(this.innerPanel)}}},getCount:function(id){var img=$("#img_"+id);img.addClass("s-icon-img");if($.trim(img.html())){return img.html()}else{return 0}},updateCount:function(url,params){var param={url:url,params:params,async:false,callback:this._callbackCount};$.DataAdapter.submit(param,this)},_callbackCount:function(data,sourceThis){var jsonData=data;if(!!jsonData&&!!jsonData.data){for(var i=0;i<jsonData.data.length;i++){var obj=jsonData.data[i];if(obj.count=="0"){$("#img_"+obj.id).hide()}else{$("#img_"+obj.id).show();$("#img_"+obj.id).html(obj.count)}}}},leftside:function(){var innerPanel=this.innerPanel;if(this.options.activeindex>0){this._panelMove(innerPanel,this.ul,this.contentWidth,this.options.activeindex-1)}if(this.options.activeindex==0){return false}else{return true}},rightside:function(){var innerPanel=this.innerPanel,num=this.ul.size();if(this.options.activeindex<this.ul.size()-1){this._panelMove(innerPanel,this.ul,this.contentWidth,this.options.activeindex+1)}if(this.options.activeindex==this.ul.size()-1){return false}else{return true}}})})(jQuery);