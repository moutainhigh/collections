(function($){$.widget("jazz.gridtreepanel",$.jazz.gridpanel,{options:{vtype:"gridtree",name:null,dataurl:null,pidkey:"pId",idkey:"id",childkey:"children",isparentkey:"isParent",levelkey:"level",isopenkey:"isopen",treecolumnname:null,paginationtype:"1"},_create:function(){this._super();this.element.addClass("jazz-gridtreepanel")},_init:function(){this.treeData=null;this.orgData=null;this.dataMap={};this.relationshipMap={};this.checkedNodeIds={};this.openNodeIds={};this._super()},_successLoadData:function(loadDataType,responseText,requestdatacomplete,isRebindPaginator){this.dataMap={};this.relationshipMap={};var that=this;if(responseText&&typeof(responseText)=="object"){var dataObj=responseText.data;if(dataObj){if(that.gpaginator){that.paginationInfo.page=dataObj.page||1;that.paginationInfo.pagerows=dataObj.pagerows||10;that.paginationInfo.totalrows=dataObj.totalrows||0;that._updatePageInfo(that.paginationInfo)}that.orgData=dataObj.rows;that.treeData=that._transformTozTreeFormat(dataObj.rows);that.treeData=that._markTreeDataLevelAndRelationship(that.treeData,0,"");if(that.treeData){if(loadDataType=="init"){this._renderGridTreepanelData("init")}else{if(loadDataType=="load"){var table=this.gtable.data("gridtable");table.removeTreeRows({length:table.getAllTreeRows().length});this._fixPageNodesData(function(){that._fixOpenNodeParent();that._renderGridTreepanelData("load");that._fixPageCheckedNodes()})}}}}}try{that.element.find(".jazz-pagearea").loading("hide")}catch(e){jazz.log(e)}},_renderGridTreepanelData:function(runType){if(this.gpaginator){var type=this.options.paginationtype,page=this.paginationInfo.page,pagerows=this.paginationInfo.pagerows,totalrows=this.paginationInfo.totalrows;var start=0,finish=pagerows-1;if(runType=="load"){var rowsData=this._getGridAllOpenTreeNodesData()}else{var rowsData=this._getGridRootTreeNodesDataByIndex(start,finish)}}else{var rowsData=this._getGridRootTreeNodesData()}var arr=this._getDataById(rowsData);if(this.gtable){var gridtable=this.gtable.data("gridtable");if(gridtable){gridtable.options.idkey=this.options.idkey;gridtable.options.pidkey=this.options.pidkey;gridtable.options.childkey=this.options.childkey;gridtable.options.treecolumnname=this.options.treecolumnname;gridtable.options.isparentkey=this.options.isparentkey;gridtable.options.levelkey=this.options.levelkey;gridtable.options.isopenkey=this.options.isopenkey;gridtable.addTreeRow(arr)}else{loopReloadData(this.gtable,"gridtable",0)}}else{}},_getGridRootTreeNodesDataByIndex:function(start,finish){finish+=1;var ids=[],id=this.options.idkey,j=finish>this.treeData.length?this.treeData.length:finish;for(var i=start;i<j;i++){ids.push(this.treeData[i][id])}return ids},_getGridRootTreeNodesData:function(){var ids=[],id=this.options.idkey;for(var i=0,j=this.treeData.length;i<j;i++){ids.push(this.treeData[i][id])}return ids},_getGridAllTreeNodesData:function(){var ids=[],id=this.options.idkey,root_len=this.treeData.length,childkey=this.options.childkey;var arrs,arr;(function(arrs){for(var i=0,l=arrs.length;i<l;i++){arr=arrs[i];ids.push(arr[id]);if(arr[childkey]&&arr[childkey].length){arguments.callee(arr[childkey])}}})(this.treeData);return ids},_getGridAllOpenTreeNodesData:function(){var ids=[],id=this.options.idkey,root_len=this.treeData.length,childkey=this.options.childkey,isopenkey=this.options.isopenkey,levelkey=this.options.levelkey;var arrs,arr,children;(function(arrs){for(var i=0,l=arrs.length;i<l;i++){arr=arrs[i];ids.push(arr[id]);if(arr[isopenkey]==true||arr[isopenkey]=="true"){arguments.callee(arr[childkey])}}})(this.treeData);return ids},_getDataById:function(arr){var ids=[];for(var i=0,j=arr.length;i<j;i++){ids.push(this.dataMap[arr[i]])}return ids},_transformTozTreeFormat:function(sNodes){var i,l,key=this.options.idkey,parentKey=this.options.pidkey,childkey=this.options.childkey;if(!key||key==""||!sNodes){return[]}if(jazz.isArray(sNodes)){var r=[];var tmpMap=[];for(i=0,l=sNodes.length;i<l;i++){tmpMap[sNodes[i][key]]=sNodes[i]}for(i=0,l=sNodes.length;i<l;i++){if(tmpMap[sNodes[i][parentKey]]&&sNodes[i][key]!=sNodes[i][parentKey]){if(!tmpMap[sNodes[i][parentKey]][childkey]){tmpMap[sNodes[i][parentKey]][childkey]=[]}tmpMap[sNodes[i][parentKey]][childkey].push(sNodes[i])}else{r.push(sNodes[i])}}return r}else{return[sNodes]}},_markTreeDataLevelAndRelationship:function(data,level,parentStep){var lv=this.options.levelkey,temp,id,pIdLink;for(var i=0,j=data.length;i<j;i++){data[i][lv]=level;id=data[i][this.options.idkey];temp=data[i][this.options.childkey];this.dataMap[id.toString()]=data[i];pIdLink=parentStep+"-"+id.toString();this.relationshipMap[id.toString()]=pIdLink;if(temp){data[i][this.options.isparentkey]=true;data[i][this.options.isopenkey]=data[i][this.options.isopenkey]||false;temp=this._markTreeDataLevelAndRelationship(temp,level+1,pIdLink)}}return data},_openNodesWithoutPaginator:function(info){var id=info.id,index=info.lineIndex,childrenkey=this.options.childkey,that=this;if(!this.dataMap[id][childrenkey]||!this.dataMap[id][childrenkey].length){this.loadChildrenData(info.id,function(data){that.addNodes(info.id,data.data.rows);that._openNodesWithoutPaginator(info)});return}this.dataMap[id][this.options.isopenkey]=true;this.gtable.data("gridtable").addTreeRow(this.dataMap[id][childrenkey],index+1)},_openNodesWithPaginator:function(info){var that=this,id=info.id,index=info.lineIndex,page=this.paginationInfo.page,pagerows=this.paginationInfo.pagerows,currentrows=this.gtable.data("gridtable").getAllTreeRows().length;var children=this.dataMap[id].children;if(!children||!children.length){this.loadChildrenData(id,function(data){that.addNodes(id,data.data.rows);that._openNodesWithPaginator(info)});return}var children_len=children.length;var leftRows=pagerows-index-1;if(leftRows<children_len){children=children.splice(index-1,children.length-index);children_len=children.length}this.dataMap[id][this.options.isopenkey]=true;this.gtable.data("gridtable").addTreeRow(children,index+1);this.gtable.data("gridtable").removeTreeRows({length:(children_len+currentrows-pagerows)})},_closeNodesWithoutPaginator:function(info){var id=info.id,index=info.lineIndex;var children_len=this.gtable.data("gridtable").getChildrenRows(index).length;this.dataMap[id][this.options.isopenkey]=false;this.gtable.data("gridtable").removeTreeRows({start:index+1,length:children_len})},_closeNodesWithPaginator:function(info){var index=info.lineIndex,lv=this.options.levelkey,id=info.id,isBreak=false,page=this.paginationInfo.page,pagerows=this.paginationInfo.pagerows,totalrows=this.paginationInfo.totalrows;var leftRows=pagerows-index-1;this.gtable.data("gridtable").removeTreeRows({start:index+1,length:leftRows});var ids=[],node=this.dataMap[id],tempNode=node,nodeType="brother";node=this.getNextNode(node);while(ids.length!=leftRows&&!isBreak){while(!(node&&nodeType=="brother")){if(nodeType=="brother"){if(tempNode[lv]==0){isBreak=true;break}else{node=this.getParentNode(tempNode);nodeType="parent"}}else{if(nodeType=="parent"){tempNode=node;node=this.getNextNode(node);nodeType="brother"}}}if(!isBreak){ids.push(node);tempNode=node;node=this.getNextNode(node)}}this.dataMap[id][this.options.isopenkey]=false;this.gtable.data("gridtable").addTreeRow(ids)},_updatePageInfo:function(page,pagerows,totalrows){if(typeof page=="object"){if(this.gpaginator){this.gpaginator.data("paginator").updatePage({page:page.page,pagerows:page.pagerows,totalrecords:page.totalrows})}}else{if(this.gpaginator){this.gpaginator.data("paginator").updatePage({page:page,pagerows:pagerows,totalrecords:totalrows})}}},_fixPageCheckedNodes:function(){var pageId=this.paginationInfo.page,table=this.gtable.data("gridtable"),id,node;var checkedNodeIds=this.checkedNodeIds["page"+pageId]||[],trs=table.getAllTreeRows();for(var i=0,j=checkedNodeIds.length;i<j;i++){id=checkedNodeIds[i];node=trs.find("#"+id);if(node.length){node.parents("tr").find(".jazz-grid-cell-box").find("input").attr("checked","checked")}}},_fixPageNodesData:function(callback){this.tempNodesLength=0;var pageId=this.paginationInfo.page,that=this;var openNodeIds=this.openNodeIds["page"+pageId];if(openNodeIds&&openNodeIds.length){for(var i=0;i<openNodeIds.length;i++){var id=openNodeIds[i];if(this.dataMap[id]&&this.dataMap[id][this.options.childkey]&&this.dataMap[id][this.options.childkey].length){continue}this.tempNodesLength++;this.loadChildrenData(id,function(data){that._checkPageNodesRequest(data,callback)})}if(this.tempNodesLength==0){if(callback&&typeof callback=="function"){callback()}}}else{if(callback&&typeof callback=="function"){callback()}}},_fixOpenNodeParent:function(){this.tempNodesLength=0;var pageId=this.paginationInfo.page,that=this,isopenkey=this.options.isopenkey,pNode,links,id;var openNodeIds=this.openNodeIds["page"+pageId]||[];for(var i=0;i<openNodeIds.length;i++){id=openNodeIds[i];links=this.relationshipMap[id].split("-");for(var j=1,k=links.length;j<k;j++){this.dataMap[links[j]][isopenkey]=true}}},_checkPageNodesRequest:function(data,callback){var pidkey=this.options.pidkey,isopen=this.options.isopenkey;this.tempNodesData=this.tempNodesData||[];data=data.data.rows;this.tempNodesData.push({pId:data[0][pidkey],data:data});if(this.tempNodesData.length==this.tempNodesLength){for(var i=0;i<this.tempNodesData.length;i++){pid=this.tempNodesData[i].pId;if(this.dataMap[pid]){this.addNodes(pid,this.tempNodesData[i].data);this.dataMap[pid][isopen]=true;this.tempNodesData.splice(i,1);i=-1}}if(callback&&typeof callback=="function"){callback()}}},_savePageNodesInfo:function(){var pageId=this.paginationInfo.page,checkedNodeIds=[],openNodeIds=[];var trs=this.gtable.data("gridtable").getAllTreeRows(),checkbox,node,nextNode;$.each(trs,function(i,tr){checkbox=$(tr).find(".jazz-grid-cell-box").find("input");node=$(tr).find(".jazz-grid-tree-cell");nextNode=$(tr).next().find(".jazz-grid-tree-cell");if(checkbox.attr("checked")=="checked"){checkedNodeIds.push(node.attr("id"))}if(nextNode.length&&node.attr("id")==nextNode.attr("pid")){openNodeIds.push(node.attr("id"))}});this.checkedNodeIds["page"+pageId]=checkedNodeIds;this.openNodeIds["page"+pageId]=openNodeIds},requestPageData:function(){var params={url:this.options.dataurl+"?page="+this.paginationInfo.page,params:{},pageparams:this.paginationInfo,showloading:false,callback:function(responseText,$this){$this._successLoadData("load",responseText,null,null)}};$.DataAdapter.submit(params,this)},getParentNode:function(id){if(typeof id=="object"){id=id[this.options.idkey]}if(id===undefined||id===null){return}var idLinks=this.relationshipMap[id].split("-");var pId=idLinks[idLinks.length-2];if(pId==""){return{children:this.treeData}}else{return this.dataMap[pId]}},getPrevNode:function(id){if(typeof id=="object"){id=id[this.options.idkey]}if(id===undefined||id===null){return}var parentNode=this.getParentNode(id),prev=null;var children=parentNode.children;for(var i=0,j=children.length;i<j;i++){if(children[i][this.options.idkey]==id){prev=i==0?null:children[i-1];break}}return prev},getNextNode:function(id){if(typeof id=="object"){id=id[this.options.idkey]}if(id===undefined||id===null){return}var parentNode=this.getParentNode(id),next=null;var children=parentNode.children;for(var i=0,j=children.length;i<j;i++){if(children[i][this.options.idkey]==id){next=i==(j+1)?null:children[i+1];break}}return next},getChildrenNodes:function(id){if(typeof id=="object"){id=id[this.options.idkey]}if(id===undefined||id===null){return}var node=this.dataMap[id];return node.children||[]},addNode:function(pId,node){this.addNodes(pId,[node])},addNodes:function(pId,nodes){if(!nodes||!jazz.isArray(nodes)){return}var idkey=this.options.idkey,lvkey=this.options.levelkey,parentLink=this.relationshipMap[pId],childkey=this.options.childkey,parentNode,id,nodeLevel;if(pId==0){nodeLevel=0}else{parentNode=this.dataMap[pId];nodeLevel=parentNode[lvkey]+1}for(var i=0,j=nodes.length;i<j;i++){id=nodes[i][idkey];this.dataMap[id]=nodes[i];this.relationshipMap[id]=parentLink+"-"+id;nodes[i][lvkey]=nodeLevel}if(pId==0){this.treeData.split(this.treeData.length-1,null,nodes)}else{if(parentNode[childkey]&&parentNode[childkey].length){this.dataMap[pId][childkey].split(parentNode.children.length-1,null,nodes)}else{this.dataMap[pId][childkey]=nodes}}},loadChildrenData:function(pId,callback){var that=this;if(this.options.dataurl){this.element.find(".jazz-pagearea").loading();var params={url:this.options.dataurl+"?pId="+pId,params:{pId:pId},pageparams:that.paginationInfo,showloading:false,callback:callback};$.DataAdapter.submit(params,that);try{that.element.find(".jazz-pagearea").loading("hide")}catch(e){jazz.log(e)}}},rebuildTreeTable:function(type,info){if(type==0){if(this.gpaginator&&this.options.paginationtype=="0"){if(info.isOpen){this._closeNodesWithPaginator(info)}else{this._openNodesWithPaginator(info)}}else{if(info.isOpen){this._closeNodesWithoutPaginator(info)}else{this._openNodesWithoutPaginator(info)}}}},bindPaginatorClickEvent:function(page,pagerows){this._savePageNodesInfo();this.paginationInfo.page=page;this.paginationInfo.pagerows=pagerows;this.requestPageData()}})})(jQuery);