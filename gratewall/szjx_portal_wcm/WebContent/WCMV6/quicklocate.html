<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<SCRIPT language=JavaScript src="js/com.trs.util/Common.js"></SCRIPT>
<SCRIPT LANGUAGE="JavaScript">
	$import('com.trs.web2frame.DataHelper');
	$import('com.trs.web2frame.TempEvaler');
	$import('com.trs.wcm.Web2frameDefault');
    $import("com.trs.suggestion.suggestion");   
</SCRIPT>
<style type="text/css">
<!--
.button12 {
	font-family: "宋体";
	font-size: 12px;
	color: #333333;
	text-decoration: none;
    display:inline;
}
.button12:link {
	font-family: "宋体";
	font-size: 12px;
	color: #333333;
	text-decoration: none;
}
.button12:hover {
	font-family: "宋体";
	font-size: 12px;
	color: #ff6600;
	text-decoration: none;
}
#quickLocateText{
    width:200px;
    height:18px;
    line-height:18px;
    display:inline;
}
body{
    margin:0px;
    padding:0px;
    font-size:12px;
    background:#fff;
    border:1px solid silver;
    border-top:0px;
}
-->
</style>
</head>
<body style="" oncontextmenu="return false;">
<table border=0 cellspacing=0 cellpadding=0 style="font-size:12px;padding-left:10px;margin-top:5px;">
    <tr>
        <td align="right">
            <select name="queryType" id="queryType" style="height:20px;font-size:12px;" onchange="changeQueryType(this)">
                <option value="nameAndPath" selected>栏目名称或路径</option>
                <option value="siteId">站点ID</option>
                <option value="channelId">栏目ID</option>
            </select>    
        </td>
        <td style="padding-left:2px;">
            <input type='text' name='quickLocateText' id='quickLocateText' style="width:170px; height:20px; line-height:20px;">
        </td>
        <td style="padding-left:2px;">
            <table width='50' height='22' border='0' cellpadding='0' cellspacing='0' class='button12' style='display:inline;'>
                <tr valign="middle">
                    <td width='8'><img src='images/bt/lkid.gif' width='8' height='22'></td>
                    <td width='100%' align='center' background='images/bt/lbg.gif' style='padding-top:3px'>
                        <a href='#' class='button12' onclick="onClickOkBtn();return false;">确定</a></td>
                    <td width='8' align='right'><img src='images/bt/rkid.gif' width='8' height='22'></td>
                </tr>
            </table>    
        </td>
    </tr>
</table>
<script>
    function init(){
        try{
            suggestion.oSuggestionRegionElement.style.display = '';
            suggestion.oSuggestionRegionShieldElement.style.display = "";
        }catch(error){}
    }
    function changeQueryType(selectObj){
        if(selectObj.value != "nameAndPath"){
            var txtObj = suggestion.oRelatedElement;
            if(isNaN(txtObj.value)){
                txtObj.value = "";
            }
            suggestion.oRelatedElement.removeAttribute("json");
            suggestion.clearAllItems();
            suggestion.oSuggestionRegionElement.style.visibility = 'hidden';
        }else{
            suggestion.oSuggestionRegionElement.style.visibility = 'visible';
        }
    }
	var suggestion = new com.trs.suggestion.Suggestion('quickLocateText');
    suggestion.dealWithOnKeyDown = suggestion.dealWithOnKeyUp = function(currSelectObj){
        if(currSelectObj == null)return;
        suggestion.oRelatedElement.setAttribute("json", currSelectObj.getAttribute("_oJson"));
    };

    suggestion.onOptionClick = function(_event, _oJson){
        suggestion.oRelatedElement.setAttribute("json", _oJson);
		if(_event.type == 'click'){
			doOK();
			return true;
		}
		var txtValue = suggestion.oRelatedElement.value;
		if(_event.type == 'keyup' && _event.keyCode == Event.KEY_RETURN){
			return false;
		}
		return true;
    };
    suggestion.dealWithOnKeyReturn = function(currSelectObj){
        var txtValue = suggestion.oRelatedElement.value;
        var queryType = $('queryType');
        if(queryType.value != "nameAndPath"){
            if(!/^\d{1,}$/.test(txtValue)){
                alert('请输入数字');
                suggestion.oRelatedElement.focus();
                suggestion.oRelatedElement.select();
                return;
            }
            if(parseInt(txtValue, 10) > 0x7fffffff){
                alert("请输入一个不大于" + 0x7fffffff + "的整数");
                return;
            }
            if(queryType.value == 'siteId'){
                var methodName = 'isValidSiteId';
                var type = 's';
            }else{
                var methodName = 'isValidChannelId';
                var type = 'c';
            }
            BasicDataHelper.call('wcm6_system', methodName, {
                ObjectId : txtValue
            }, false, function(transport, json){
                if(transport.responseText.indexOf("true") >= 0){                        
                    action(type, txtValue);
                }else{                        
                    alert("没有找到对应的" + (type=='s' ? "站点" : "栏目"));
                    suggestion.oRelatedElement.focus();
                    suggestion.oRelatedElement.select();
                }
            });
        }else{            
            if(txtValue.indexOf("\\") < 0){
                suggestion.sendRequest(Prototype.emptyFunction, function(otransport, ojson){
                    var elements = ojson["ROOT"]["ELEMENT"];
                    if(elements.length <= 1){
                        $alert('没有找到匹配的结果');
                    }                
                });
            }else{
                var currSelectDom = suggestion.getCurrSelect();
                if(currSelectDom && currSelectDom.innerHTML == txtValue){
                    suggestion.oRelatedElement.setAttribute("json", currSelectDom.getAttribute("_oJson"));
                    doOK();
                }else{
                    suggestion.sendRequest(Prototype.emptyFunction, function(otransport, ojson){
                        var elements = ojson["ROOT"]["ELEMENT"];
                        if(elements[0]["PARENTID"] != "-1"){
                            suggestion.oRelatedElement.setAttribute("json", {type:elements[0]["PARENTTYPE"], id:elements[0]["PARENTID"]});						
                            doOK();
                        }else{
                            $alert('不能定位到指定的目标对象['+suggestion.oRelatedElement.value+"]");
                        }                    
                    });
                }
            }        
        }
    };
    function afterRequest(otransport, ojson){
        var elements = ojson["ROOT"]["ELEMENT"];

        if(elements.length > 1){
            suggestion.oSuggestionRegionElement.style.display = '';
            suggestion.oSuggestionRegionShieldElement.style.display = "";
        }else if(elements.length == 1){
            suggestion.oRelatedElement.setAttribute("json", {type:elements[0]["TYPE"], id:elements[0]["ID"]});
            doOK();
        }else{
            suggestion.oSuggestionRegionElement.style.display = '';
            suggestion.oSuggestionRegionShieldElement.style.display = "";
        }

    }
    suggestion.doOnCommonKey = function(nKeyCode){
        if($('queryType').value != "nameAndPath"){
            return;
        }
        if(nKeyCode != 8 && nKeyCode != 220){// '\' '<-'
			var txtValue = suggestion.oRelatedElement.value;
			if(txtValue.indexOf("\\") >= 0){
				suggestion.hideNotMatch();
			}
            return false;
        }
        var txtValue = suggestion.oRelatedElement.value;
        if(/(.)*\\$/.test(txtValue) && !/(.)*\\\\$/.test(txtValue)){//keycode == '\'
            this.sendRequest();	
			return true;
        }
		return false;
    };
    suggestion.sendRequest = function(beforeSend, afterSend){
        if(beforeSend) beforeSend();
		this.clearAllItems();
		var oHelper = new com.trs.web2frame.BasicDataHelper();
        oHelper.Call('wcm6_system', 'findNodesByPath', {
                Path : suggestion.oRelatedElement.value,
				fieldsToHtml:'PATH'
            }, true, function(otransport, ojson){
				var elements = ojson["ROOT"]["ELEMENT"];
				for (var i = 1; i < elements.length; i++){
					suggestion.addItem(elements[i]["PATH"], {type:elements[i]["TYPE"], id:elements[i]["ID"]});
				}
				if(afterSend){
					afterSend(otransport, ojson);
				}
                if(elements.length == 0){
                    alert("没有找到符合条件的对象");
                    suggestion.oRelatedElement.focus();
                    suggestion.oRelatedElement.select();
                }
        });
    };

    function doOK(){
        var obj = suggestion.oRelatedElement.getAttribute("json");       
        if(obj){
            obj.type = obj.type.toLowerCase();
            var type = (obj.type == 'sitetype' ? 'r' : (obj.type == 'site' ? 's' : 'c'));
            action(type, obj.id);
        }
    }

    function action(type, id){
        id = parseInt(id, 10);
        var treeWindow = (top.actualTop||top).document.getElementById('nav_tree').contentWindow;
        treeWindow.focus(type, id, null, function(){
            var treeNode = treeWindow.$(type + "_" + id);   
            treeNode.scrollIntoView();   
            treeWindow.refreshMain();
        });
        suggestion.oRelatedElement.blur();
        parent.TRSDialogContainer.close('quicklocate');      
    }

    function onClickOkBtn(){
        suggestion.dealWithOnKeyReturn();
        suggestion.oRelatedElement.focus();
    }
</script>
</body>
</html>