<HTML xmlns:TRS_UI>
<HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <TITLE WCMAnt:param="document_relations.html.title">TRS WCM 相关文档管理</TITLE>
  <link href="../css/common.css" rel="stylesheet" type="text/css" />
  <link href="metaview_document_relations.css" rel="stylesheet" type="text/css"/>
  <script language="javascript">
  <!--
	document.write('<script language="javascript" src="product_features_info_include.jsp' + location.search + ' type="text/javascript"><\/script>');
  //-->
  </script>

<script language="javascript">
var PageContext = {};
var PRV_OBJ_TYPE_DOCUMENT = "Document_Relation";
var PRV_OBJ_TYPE_CHNLDOC = "ChnlDoc_Relation";
var PRV_OBJ_TYPE_CURRPAGE = "CurrPage_Relation";
</script>
</HEAD>

<BODY style="margin:0;padding:0;">
	<TABLE width="620" height="100%" border="0" cellpadding="0" cellspacing="0">
		<TR>
			<TD valign="top">			
				<DIV id="docs_explorer" style="background:#FFFFFF;padding:0;height:350px;overflow:auto;">
					<TABLE height="300" border="0" cellpadding="0" cellspacing="1" style="font-size:12px;background:gray;width:100%;">
						<TR bgcolor="#FFFFFF">
							<TD width="191">
								<iframe src="../include/blank.html" id="treeNav" allowtransparency="true" scrolling="auto" frameborder="0" style="width:191px;height:100%;"></iframe>
							</TD>
							<TD width="480">
								<DIV id="search" style="width:420px;height:22px;overflow:hidden;font-size:12px;display:none">
									<SPAN style="float:right;height:22px;margin-right:20px;">
									<select name="FieldName" id="FieldName" style="float:left;width:60px;height:18px;overflow:hidden;marign:-2px 4px 0 0;">
										<option value="DocTitle" WCMAnt:param="metaview_document_relations.html.title">标题</option>
										<option value="CrUser" WCMAnt:param="metaview_document_relations.html.pulishman">发稿人</option>
										<option value="DocKeywords" WCMAnt:param="metaview_document_relations.html.keywords">关键词</option>
									</select>
									<input id="SearchWord" type='text' class="input_text" style="float:left;border-color:gray;height:18px;width:100px;margin:2px 3px 0;">
									<SPAN style="float:left;border:1px solid gray;height:16px;margin-top:2px;padding:1 4px;cursor:pointer" tabIndex="1" onclick="doSearch();" WCMAnt:param="metaview_document_relations.html.search">检索</SPAN></SPAN>
								</DIV>
								<iframe id='channel_doc_list' src="../include/blank.html" allowtransparency="true" scrolling="no" frameborder="0" style="width:565px;height:340px;"></iframe>
							</TD>
						</TR>
					</TABLE>
				</DIV>
				<fieldset style="background:#FFFFFF;padding:0;height:130px;width:770px;">
					<legend style="line-height:24px;font-size:12px;" WCMAnt:param="metaview_document_relations.html.settedrelateddocs">已设置的相关文档</legend>
					<div id="curr_relations" style="width:765px;height:130px;overflow:auto;"></div>
				</fieldset>
			</TD>
		</TR>
	</TABLE>
	<textarea id="template_relations" style="display:none">
		<TABLE width="745" border="0" cellpadding="0" cellspacing="1" class="relations_grid">
			<THEAD align="center" valign="middle" class="grid_head">
				<TD width="40" WCMAnt:param="metaview_document_relations.html.sortnumber">序号</TD>
				<TD width="560" WCMAnt:param="metaview_document_relations.html.relateddoctitle">相关文档标题</TD>
				<TD width="40" WCMAnt:param="metaview_document_relations.html.template">版式</TD>
				<TD width="40" WCMAnt:param="metaview_document_relations.html.preview">预览</TD>
				<TD width="40" WCMAnt:param="metaview_document_relations.html.delete">删除</TD>
				<TD width="40" WCMAnt:param="metaview_document_relations.html.sort">排序</TD> 
			</THEAD>
			<TBODY id="ralations_tbody">
		    <for select="Relations.Relation" blankRef="noObjectFound">
			<TR align="center" valign="middle" class="grid_row" tempid="{#RELDOC.TEMPID}" grid_rowid="{#RELDOC.Id}" relation_order="{$$INDEX}">
				<TD>
					{$$INDEX}
				</TD>
				<TD align="left">
					<div class="doctitle">{@$transHtml(#RELDOC.Title)}</div>
				</TD>
				<TD align="left">
					<div class="templates-cls" imgs="{#RELDOC.IMGS}" recid="{#RELDOC.Id}" tempid="{#RELDOC.TEMPID}"></div>
				</TD>
				<TD>
					<SPAN class="row_preview grid_function" grid_function="preview">&nbsp;&nbsp;</SPAN>
				</TD>
				<TD>
					<SPAN class="row_delete grid_function" grid_function="delete">&nbsp;&nbsp;</SPAN>
				</TD>
				<TD>
					<input type="text" name="order" class="row_order" _value="{$$INDEX}" value="{$$INDEX}">
				</TD>
			</TR>
			</for>
			</TBODY>
		</TABLE>
	</textarea>
	<TABLE style="display:none">
	<TBODY id="noObjectFound">
		<TR class="grid_row">
			<TD></TD><TD></TD><TD></TD><TD></TD><TD></TD><TD></TD>
		</TR>
	</TBODY>
	</TABLE>
<script src="../js/runtime/myext-debug.js"></script>
<script src="../js/source/wcmlib/WCMConstants.js"></script>
<script src="../js/source/wcmlib/core/MsgCenter.js"></script>
<script src="../js/data/locale/document.js"></script>
<script src="../js/source/wcmlib/core/CMSObj.js"></script>
<script src="../js/source/wcmlib/core/AuthServer.js"></script>
<script src="../js/source/wcmlib/com.trs.floatpanel/FloatPanelAdapter.js"></script>
<link rel="stylesheet" type="text/css" href="../css/wcm-common.css">
<script src="../js/source/wcmlib/com.trs.web2frame/TempEvaler.js"></script>
<script src="../js/source/wcmlib/com.trs.web2frame/AjaxRequest.js"></script>
<script src="product_features_verify.js"></script>
<script>
var m_Relations = Object.deepClone(FloatPanel.dialogArguments.relations) || {};
var m_CurrDocId = FloatPanel.dialogArguments.CurrDocId;
var m_CurrChannelId = FloatPanel.dialogArguments.CurrChannelId || '';
var m_nSiteType =  FloatPanel.dialogArguments.SiteType || "0,4";
var SELECT_TYPE = FloatPanel.dialogArguments.SelectType == 'radio' ? 'radio' : 'checkbox';
var m_nRelationViewId = $GViewId;
window.m_fpCfg = {
	m_arrCommands : [{
		cmd : 'myClose',
		name : '保存'
	}],
	size : [800, 510]
};
function myClose(){
	var doms = document.getElementsByClassName("grid_row", $('curr_relations'));
	var aTempIds = [];
	var aRecIds = [];
	for(var i=0; i < doms.length; i++){
		if(!doms[i].getAttribute("tempid")){
			continue;
		}
		aTempIds.push(doms[i].getAttribute("tempid"));
		aRecIds.push(doms[i].getAttribute("grid_rowid"));
	}

	if(aRecIds.join("").length <= 0 || aTempIds.join("").length <= 0){
		alert("记录或版式不存在");
		return false;
	}

	//校验版式是否连续
	var sels = document.getElementsByName('featurestemps');
	var items = [];
	for(var index = 0; index < sels.length; index++){
		var desc = sels[index].options[sels[index].selectedIndex].text;
		var result = desc.match(/\((\d+)-(\d+)\)/);
		result ? items.push([parseInt(result[1], 10), parseInt(result[2], 10)]) : items.push([1, 1]);
	}
	
	var splitIndexes = VerifySequence(items);
	if(!splitIndexes){
		alert("选择的版式不完整");
		return false;
	}

	var sUrl = "product_features_preview.jsp?IncludeResource=0&objectids="+aRecIds.join(",")+"&templateids="+aTempIds.join(",")+"&splitIndexes="+splitIndexes.join(",");
	new Ajax.Request(sUrl, {
		onComplete : function(transport, json){
			notifyFPCallback(transport.responseText);
			closeWindow();
		}
	});
	return false;
}

function fastCreate(namespace, scope){
	scope = scope || window;
	if(namespace==null || namespace=='')return;
	var arr = namespace.split('.');
	for(var i=0,n=arr.length;i<n;i++){
		if(!scope[arr[i]]){
			scope[arr[i]] = {};
		}
		scope = scope[arr[i]];
	}
}
function getRelationsArray(relations){
	var arr = $v(relations, "RELATIONS.RELATION");
	fastCreate("RELATIONS.RELATION", relations);
	if(arr==null || arr==false){
		arr = relations["RELATIONS"]["RELATION"] = [];
	}
	else if(!Array.isArray(arr)){
		var tmpArr = relations["RELATIONS"]["RELATION"] = [];
		tmpArr.push(arr);
		arr = tmpArr;
	}
	return arr;
}
function refreshGrid(){
	Element.update($('curr_relations'), '');
	var sValue = TempEvaler.evaluateTemplater('template_relations', m_Relations, {});
	Element.update($('curr_relations'), sValue);
	renderTemplatesHtml();
}

function changeTemplate(sel){
	var recid = sel.parentNode.getAttribute("recid") || 0;
	var tempid = sel.value;
	var arr = getRelationsArray(m_Relations);
	for(var i=0;i<arr.length;i++){
		if(recid==$v(arr[i], "RELDOC.ID")){			
			arr[i]["RELDOC"]["TEMPID"] = tempid;
			break;
		}
	}
	
	var dom = sel;
	while(dom && dom.tagName != 'BODY'){
		if(dom.getAttribute("tempid") != null){
			dom.setAttribute("tempid", tempid);
		}
		dom = dom.parentNode;
	}
}

function isValidTemp(imgs, tempDesc){
	var descs = tempDesc.split(",");
	for(var index = 0; index < descs.length; index++){
		var newImgs = imgs.replace(new RegExp(descs[index], ''));
		if(imgs.length == newImgs.length){
			return false;
		}
		imgs = newImgs;
	}
	return true;
}

function getTemplatesHtml(imgs){
	var templates = window.$GTemplates;
	var aHtml = [];
	aHtml.push("<select name='featurestemps' onchange='changeTemplate(this)'>");
	for(var index = 0; index < templates.length; index++){
		var tempDesc = templates[index].Desc;
		if(isValidTemp(imgs, tempDesc)){
			aHtml.push("<option", " value='", templates[index].Id, "'>", templates[index].Name, "</option>");
		}
	}
	aHtml.push("</select>");
	return aHtml.join("");
}

function renderTemplatesHtml(currIndex){
	var doms = document.getElementsByClassName('templates-cls', $('ralations_tbody'));

	for(var index = 0; index < doms.length; index++){
		doms[index].innerHTML = getTemplatesHtml(doms[index].getAttribute("imgs"));
		var tempId = doms[index].getAttribute("tempid");
		var sel = doms[index].getElementsByTagName("select")[0];
	
		if(tempId){
			sel.value = tempId;
		}else{
			doms[index].setAttribute("tempid", sel.value);
			var node = doms[index];
			while(node){
				if(node.getAttribute("grid_rowid") != null){
					node.setAttribute("tempid", sel.value);
					break;
				}
				node = node.parentNode;
			}
		}
	}
}
Ext.apply(PageContext, {
	collectDatas : function(){
	},
	"add" : function(_Relation){
		this.collectDatas();
		var arr = getRelationsArray(m_Relations);
		var nRelDocId = _Relation["RelDocId"];
		for(var i=0;i<arr.length;i++){
			if(nRelDocId==$v(arr[i], "RELDOC.ID"))
				return;
		}
		var oRelation = {
			RELDOC : {
				IMGS : _Relation['Imgs'],
				ID : nRelDocId,
				CHANNELID : _Relation["RelDocChannelId"],
				TITLE : _Relation["RelDocTitle"]
			},
			RELATIONID : 0
		};
		arr.push(oRelation);
		m_Relations["RELATIONS"]["RELATION"] = arr;
		refreshGrid();
	},
	"mydelete" : function(row){
		this.collectDatas();
		var relDocId = row.getAttribute("grid_rowid", 2);
		var arr = getRelationsArray(m_Relations);
		var result = [];
		for(var i=0;arr&&i<arr.length;i++){
			if(relDocId != $v(arr[i],"RELDOC.ID")){
				result.push(arr[i]);
			}
		}
		m_Relations["RELATIONS"]["RELATION"] = result;
		refreshGrid();
	},
	"preview" : function(row){
		var nRecId = row.getAttribute("grid_rowid", 2);
		var nTemplateId = row.getAttribute("tempid", 2);
		window.open("product_features_preview.jsp?objectids="+nRecId+"&templateids="+nTemplateId);
	},
	"delete" : function(row){
		CMSObj.createFrom({
			objId : row.getAttribute("grid_rowid", 2),
			objType : PRV_OBJ_TYPE_DOCUMENT
		}).afterunselect();
	},
	"deleteById" : function(_RelDocId){
		var tBody = $('ralations_tbody');
		var rows = tBody.rows;
		for(var i=0;i<rows.length;i++){
			if(_RelDocId==rows[i].getAttribute("grid_rowid", 2)){
				PageContext['mydelete'](rows[i]);
				break;
			}
		}
	}
});
function getRow(target){
	while(target!=null && target.tagName!='BODY'){
		if(target.getAttribute('grid_rowid', 2))return target;
		target = target.parentNode;
	}
	return null;
}
function doGridFunction(event, target){
	var row = getRow(target);
	if(row==null)return;
	var gridFunc = target.getAttribute('grid_function', 2);
	if(!PageContext[gridFunc])return;
	PageContext[gridFunc](row);
}

//change order start
var OrderHandler = {
	init : function(dom){
		if(dom.getAttribute('inited')) return;
		dom.setAttribute('inited', true);
		dom.onblur = OrderHandler.blur;
		dom.onkeydown = OrderHandler.keydown;
	},
	destroy : function(dom){
		dom.removeAttribute('inited');
		dom.onblur = null;
		dom.onkeydown = null;
	},
	valid : function(dom){
		if(!/^\d+$/.test(dom.value)){
			alert('请输入合法的数字');
			dom.select();
			return false;
		}		
		return true;
	},
	blur : function(event){
		var dom = this;
		if(!OrderHandler.valid(dom)) return;
		OrderHandler.destroy(dom);
		OrderHandler.change(dom);
	},
	keydown : function(event){
		event = window.event || event;
		if(event.keyCode != 13) return;
		this.blur();
	},
	change : function(dom){
		var relations = m_Relations["RELATIONS"]["RELATION"];
		var newOrder = dom.value;
		if(newOrder <= 0) newOrder = 1;
		if(newOrder > relations.length) newOrder = relations.length;
		var oldOrder = dom.getAttribute("_value");
		if(oldOrder == newOrder) return;
		OrderHandler.insert(relations, oldOrder - 1, newOrder - 1);
		refreshGrid();
	},
	insert : function(arr, from, to){
		arr.splice(to, 0, arr.splice(from, 1)[0]);
	}
};
//change order end

Event.observe(window, 'load', function(){
	$('treeNav').src = '../include/metaview_channel_list.jsp?siteTypes='+m_nSiteType+'&ChannelId='+m_CurrChannelId+'&MetaViewId=' + m_nRelationViewId;
	refreshGrid();
	loadKeyWords();
	Ext.get('curr_relations').on('click', function(event, target){
		if(target.getAttribute('grid_function', 2)){
			return doGridFunction(event, target);
		}
	});
	Ext.get('curr_relations').on('keydown', function(event, target){
		if(target.name != 'order') return;
		OrderHandler.init(target);
	});
});
$MsgCenter.on({
	objType : PRV_OBJ_TYPE_CURRPAGE,
	afterinit : function(event){
		var objs = CMSObj.createEnumsFrom({
			objType : PRV_OBJ_TYPE_DOCUMENT
		});
		var arr = getRelationsArray(m_Relations);
		for(var i=0, n=arr.length; i<n; i++){
			objs.addElement(CMSObj.createFrom({
				objId : $v(arr[i], "RELDOC.ID"),
				objType : PRV_OBJ_TYPE_DOCUMENT
			}));
		}
		objs.afterselect();
	}
});

function getMainUrl(){
	return '../application/' + $GViewId + '/metaviewdata_select_list_4_img.html';
}

function doSearch(){
	var oPostData = Ext.Json.toUpperCase($('channel_doc_list').src.parseQuery());
	var selFieldName = $('FieldName');
	var sFieldName = selFieldName.value;
	for (var i = 0; i < selFieldName.options.length; i++){
		delete oPostData[selFieldName.options[i].value.toUpperCase()];
	}
	oPostData[sFieldName] = $('SearchWord').value;
	$('channel_doc_list').src = 'document_relation_select.html?' + $toQueryStr(oPostData);
}
function loadKeyWords(){
	var sKeyWords = FloatPanel.dialogArguments.DocKeyWords;
	if(sKeyWords && sKeyWords.trim()!=''){
		$('FieldName').value = 'DocKeywords';
		$('SearchWord').value = sKeyWords;
		doSearch();
	}
}
function mappingHostWithObjType(objType){
	switch(objType){
		case WCMConstants.OBJ_TYPE_WEBSITEROOT:
			return WCMConstants.TAB_HOST_TYPE_WEBSITEROOT;
		case WCMConstants.OBJ_TYPE_WEBSITE:
			return WCMConstants.TAB_HOST_TYPE_WEBSITE;
		case WCMConstants.OBJ_TYPE_CHANNEL:
			return WCMConstants.TAB_HOST_TYPE_CHANNEL;
		case WCMConstants.OBJ_TYPE_MYFLOWDOCLIST:
			return WCMConstants.TAB_HOST_TYPE_MYFLOWDOCLIST;
		case WCMConstants.OBJ_TYPE_MYMSGLIST:
			return WCMConstants.TAB_HOST_TYPE_MYMSGLIST;
	}
}
$MsgCenter.on({
	objType : PRV_OBJ_TYPE_CHNLDOC,
	afterselect : function(event){		
		var obj = event.getObjs().getAt(0);
		if(obj==null)return;
		var relation = {
			Imgs : obj.getPropertyAsString('imgs'),
			RelDocId : obj.getPropertyAsInt('docid', 0),
			RecId : obj.getId(),
			RelDocChannelId : obj.getPropertyAsInt('channelid', 0),
			RelDocTitle : obj.getPropertyAsString('doctitle', '')
		};
		PageContext.add(relation);
	},
	afterunselect : function(event){
		var obj = event.getObjs().getAt(0);
		if(obj==null)return;
		PageContext.deleteById(obj.getPropertyAsInt('docid', 0));
	}
});
$MsgCenter.on({
	objType : PRV_OBJ_TYPE_DOCUMENT,
	afterunselect : function(event){
		var obj = event.getObjs().getAt(0);
		if(obj==null)return;
		PageContext.deleteById(obj.getId());
	}
});

$MsgCenter.on({
	objType : PRV_OBJ_TYPE_CHNLDOC,
	afterselect : function(event){
		if(SELECT_TYPE != 'radio') return;
		var obj = event.getObjs().getAt(0);
		if(obj==null)return;
		var relation = {
			Imgs : obj.getPropertyAsString('imgs'),
			RelDocId : obj.getPropertyAsInt('docid', 0),
			RecId : obj.getId(),
			RelDocChannelId : obj.getPropertyAsInt('channelid', 0),
			RelDocTitle : obj.getPropertyAsString('doctitle', '')
		};
		m_Relations["RELATIONS"]["RELATION"] = [];
		refreshGrid();
		PageContext.add(relation);
	}
});

</SCRIPT>
</BODY>
</HTML>