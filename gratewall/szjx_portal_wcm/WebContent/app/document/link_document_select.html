<HTML xmlns:TRS_UI>
<HEAD>
	<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<TITLE WCMAnt:param="link_document_select.html.selectLinkDocument">选择链接文档</TITLE>
	<!--css-->
    <link href="../../app/js/resource/widget.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../css/wcm-common.css">
    <link rel="stylesheet" type="text/css" href="../css/wcm-list-common.css">

	<script src="../js/runtime/myext-debug.js"></script>
	<script src="../js/source/wcmlib/WCMConstants.js"></script>
	<script src="../js/data/locale/document.js"></script>
	<script src="../js/source/wcmlib/core/MsgCenter.js"></script>
	<script src="../js/source/wcmlib/core/CMSObj.js"></script>
	<SCRIPT src="../js/source/wcmlib/Observable.js"></SCRIPT>
	<!--AJAX-->
	<script src="../js/source/wcmlib/com.trs.web2frame/AjaxRequest.js"></script>
	<script language="javascript">
		//从上下文中获取参数。
		var CurrChannelId = getParameter("DocChannelId");
		var CurrDocId = getParameter("DocId");
		var PRV_OBJ_TYPE_DOCUMENT = "Document_Relation";
		var PRV_OBJ_TYPE_CURRPAGE = "CurrPage_Relation";
	</script>
	<style type="text/css">
		body {
			padding-top:0px;
			background-color: #CCCCCC;
		}
		.input_btn{
			width:80px;
			margin-right:10px;
		}
	</style>
	<script language="javascript">
	<!--
		$MsgCenter.on({
			objType : WCMConstants.OBJ_TYPE_TREENODE,
			afterclick : function(event){
				//负责导航树对应的页面切换
				var context = event.getContext();
				var objId = context.objId;
				var objType = context.objType;
				var sParams = '';
				var sHostType = mappingHostWithObjType(objType);
				var mySrc = '../document/document_relation_select.html?SelectType=checkbox';
				switch(objType){
					case WCMConstants.OBJ_TYPE_WEBSITEROOT:
						return false;
					case WCMConstants.OBJ_TYPE_WEBSITE:
						sParams = '&SiteId=' + objId;
						sParams += '&SiteType=' + context.siteType;
						break;
					case WCMConstants.OBJ_TYPE_CHANNEL:
						sParams = '&ChannelId=' + objId;
						sParams += '&SiteType=' + context.siteType;
						sParams += '&IsVirtual=' + context.isVirtual;
						sParams += '&ChannelType=' + context.channelType;
						break;
				}
				sParams += '&RightValue=' + context.right;
				sParams += '&ExcludeDocIds=' + CurrDocId;
		//		sParams += '&' + $('FieldName').value + '=' + $('SearchWord').value;
				$('channel_doc_list').src = mySrc + '&' + sParams;
				return false;
			}
		});
		$MsgCenter.on({
			objType : PRV_OBJ_TYPE_CURRPAGE,
			afterinit : function(event){
				var objs = CMSObj.createEnumsFrom({
					objType : PRV_OBJ_TYPE_DOCUMENT
				});
				for(var i=0, n=defaultSelect.length; i<n; i++){
					objs.addElement(CMSObj.createFrom({
						objId : defaultSelect[i],
						objType : PRV_OBJ_TYPE_DOCUMENT
					}));
				}
				objs.afterselect();
			}
		});
		$MsgCenter.on({
			objType : WCMConstants.OBJ_TYPE_CHNLDOC,
			afterselect : function(event){
				var obj = event.getObjs().getAt(0);
				if(obj==null)return;
				AddSelectedDoc(obj.getPropertyAsInt('docid', 0), obj.getId());
				defaultSelect.push(obj.getPropertyAsInt('docid', 0));
			},
			afterunselect : function(event){
				var obj = event.getObjs().getAt(0);
				if(obj==null)return;
				RemoveSelectedDoc(obj.getPropertyAsInt('docid', 0), obj.getId());
				defaultSelect.remove(obj.getPropertyAsInt('docid', 0));
			}
		});
		var hsSelectedDocIds = {};
		var defaultSelect = [];
		function mappingHostWithObjType(objType){
			switch(objType){
				case WCMConstants.OBJ_TYPE_WEBSITEROOT:
					return WCMConstants.TAB_HOST_TYPE_WEBSITEROOT;
				case WCMConstants.OBJ_TYPE_WEBSITE:
					return WCMConstants.TAB_HOST_TYPE_WEBSITE;
				case WCMConstants.OBJ_TYPE_CHANNEL:
					return WCMConstants.TAB_HOST_TYPE_CHANNEL;
				case WCMConstants.OBJ_TYPE_MYFLOWDOCLIST:
					return WCMConstants.TAB_HOST_TYPE_MYFLOWDOCLIST;
				case WCMConstants.OBJ_TYPE_MYMSGLIST:
					return WCMConstants.TAB_HOST_TYPE_MYMSGLIST;
			}
		}
		function AddSelectedDoc(_nDocId,_sRelDocId){
			hsSelectedDocIds[_nDocId] = _sRelDocId;
		}
		function RemoveSelectedDoc(_nDocId,_sRelDocId){
			if(hsSelectedDocIds[_nDocId]==_sRelDocId)
				delete hsSelectedDocIds[_nDocId];
		}
		function Ok(isAbsoluteUrl){
			var arrDocIds = [];
			for(var sDocId in hsSelectedDocIds){
				arrDocIds.push(sDocId);
			}
			var oPostData = {
				"isAbsoluteUrl" : isAbsoluteUrl === true ? 1 : 0,
				"DocumentIds" : arrDocIds.join(','),
				"CaseSensitive" : true
			}
			var oHelper = new com.trs.web2frame.BasicDataHelper();
			oHelper.JspRequest('document_publish_info.jsp',oPostData,false,
				function(_transport,_json){
					if(_json&&_json["DOCUMENTS"]){
						var oMyObject = window.dialogArguments;
						window.returnValue = _json["DOCUMENTS"];
						//CreateLinks(_json["DOCUMENTS"]);
					}
					window.close();
				}
			);
			return false;
		}
	</script>
</HEAD>
<BODY style="margin:0px;padding:0px;">
		<TABLE style="table-layout:fixed;">
			<TR>
				<TD width="180" height="430" valign="top">
					<iframe src="../include/blank.html" id="treeNav" allowtransparency="true" scrolling="no" frameborder="0"></iframe>
				</TD>
				<td width="585" height="430" valign="top">
					<iframe id='channel_doc_list' src="../include/blank.html" allowtransparency="true" scrolling="no" frameborder="0"></iframe>
				</TD>
				<TD width="10" align="center" valign="top">
					<div style="width:2px;border-left:1px solid gray;background:white;height:430px;"></div></td>
				<TD width="90" valign="top">
					<input id="btnRelative" class="input_btn" onclick="window.parent.Ok(false);" type="button" value="相对地址" WCMAnt:paramattr="value:link_document_select.html.relativeurl"/>
					<div style="height:5px;"></div>
					<input id="btnAbsolute" class="input_btn" onclick="window.parent.Ok(true);" type="button" value="绝对地址" WCMAnt:paramattr="value:link_document_select.html.absoluteurl"/>
					<div style="height:5px;"></div>
					<input name="button2" class="input_btn" type="button" value="取消" onclick="window.close();" WCMAnt:paramattr="value:link_document_select.html.cancel"/>
				</TD>
			</TR>
		</TABLE>
<script>
	Event.observe(window, 'load', function(){
		$('treeNav').src = '../nav_tree/nav_tree_inner.html?siteTypes=0,4&ChannelId='+CurrChannelId;;
	});
	function doSearch(){
		var oPostData = Ext.Json.toUpperCase($('channel_doc_list').src.parseQuery());
		var selFieldName = $('FieldName');
		var sFieldName = selFieldName.value;
		for (var i = 0; i < selFieldName.options.length; i++){
			delete oPostData[selFieldName.options[i].value.toUpperCase()];
		}
		oPostData[sFieldName] = $('SearchWord').value;
		$('channel_doc_list').src = 'document_relation_select.html?' + $toQueryStr(oPostData);
	}
</script>
</BODY>
</HTML>