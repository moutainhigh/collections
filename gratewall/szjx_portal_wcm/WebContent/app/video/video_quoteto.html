<html xmlns="http://www.w3.org/1999/xhtml" xmlns:TRS="" xmlns:TRS_UI="">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title id="tlDoc" WCMAnt:param="document_quoteto.html.videoquotedto">视频引用到...</title>
<script src="../../app/js/runtime/myext-debug.js"></script>
<script src="../../app/js/source/wcmlib/WCMConstants.js"></script>
<script src="../../app/js/source/wcmlib/core/MsgCenter.js"></script>
<script src="../../app/js/source/wcmlib/core/CMSObj.js"></script>
<script src="../../app/js/source/wcmlib/core/AuthServer.js"></script>
<script src="../../app/js/data/locale/document.js"></script>
<script src="../../app/js/source/wcmlib/com.trs.floatpanel/FloatPanelAdapter.js"></script>
<script src="../../app/js/data/locale/ajax.js"></script>
<script src="../../app/js/source/wcmlib/com.trs.web2frame/AjaxRequest.js"></script>
<script src="../js/runtime/data/locale_all.js"></script>

<SCRIPT src="../../app/js/source/wcmlib/Observable.js"></SCRIPT>
<SCRIPT src="../../app/js/source/wcmlib/Component.js"></SCRIPT>
<SCRIPT src="../../app/js/source/wcmlib/dialog/Dialog.js"></SCRIPT>
<SCRIPT src="../../app/js/source/wcmlib/dialog/DialogAdapter.js"></SCRIPT>
<link href="../../app/js/resource/widget.css" rel="stylesheet" type="text/css" />

<script language="javascript">
window.m_fpCfg = {
	m_arrCommands : [{
		cmd : 'getSeletedIds',
		name : wcm.LANG.DOCUMENT_PROCESS_31 || '确定'
	}],
	size : [420, 450]
};
</script>
<script>
	var sChannelIds = getParameter("channelids");
	var sObjectids = getParameter("objectids");
	var channelType = getParameter("channelType");

	function getSeletedIds(){
		var modes = document.getElementsByName("mode");
		var sSelIds = null;
		var sSelNames = null;
		var sIframeId = 'allTreeNav';
		if(modes[0].checked){
			sIframeId = 'clusterList';
		}
		else if(modes[1].checked){
			sIframeId = 'allTreeNav';
		}
		else{
			Ext.Msg.alert(wcm.LANG.METAVIEWDATA_2 || '没选中任何模式');
			return false;
		}
		var win = $(sIframeId).contentWindow;
		try{
			sSelIds =  win.getCheckValues();
		}catch(err){
			sSelIds = '';
		}
		try{
			sSelNames = win.getCheckNames();
		}catch(err){
			sSelNames = '';
		}
		if(!sSelIds||sSelIds.length==0) {
			Ext.Msg.$alert(wcm.LANG.VIDEO_PROCESS_40 || '请选择当前视频要引用到的目标栏目!');
			return false;
		}
		//else
		//ProcessBar.init(wcm.LANG.DOCUMENT_PROCESS_33 || '执行进度，请稍候...');
		//ProcessBar.addState(wcm.LANG.DOCUMENT_PROCESS_34 || '正在提交数据');
		//ProcessBar.addState(wcm.LANG.DOCUMENT_PROCESS_35 || '成功执行完成');
		//ProcessBar.start();
		var sQuoteType = getQuoteType();
		var oPostData = {
			"ObjectIds" : sObjectids,
			"channelids" : sChannelIds,
			"ToChannelIds" : sSelIds.join(',')
		}
		var func =  null;
		/*
		if(false&&sSelIds.include(sChannelIds)){
			var sFunc = "$MessageCenter.refresh('main','channelid="+sChannelIds+"');";
			func = new (top.actualTop||top).Function(sFunc);
		}
		*/
		func = function(){
			//$MessageCenter.sendMessage('main','PageContext.RefreshSearchList', 'PageContext');
			FloatPanel.close();
		};
		
		/*		//包含表单的时候，需要判断当前选中的栏目是不是与被操作的栏目配置有同一个表单
		if(channelType.indexOf('13')>=0){
			var sUrl = '../infoview/infoview_employer_filter2.jsp';
				sUrl += '?FromChannelId=' + sChannelIds;
				sUrl += '&ToChannelIds=' + sSelIds.join(",");
				sUrl += '&IsRefer=1'; //非复制
			new Ajax.Request(sUrl, {'onSuccess' : 
				function(_trans, _json){
					var result = _trans.responseText.trim();
					var sFilterIds = '';
					if(parseInt(result,10) > 1){
						alert("所选的栏目中有与源栏目使用的表单不一致！");
						return false;
					}
					var oHelper = new com.trs.web2frame.BasicDataHelper();
					oHelper.Call('wcm6_viewdocument',sQuoteType,oPostData,true,
						function(_transport,_json){
							//ProcessBar.exit();
							Ext.Msg.report(_json,wcm.LANG.DOCUMENT_PROCESS_47 || '文档引用结果',func);
							FloatPanel.hide();
						},
						function(_transport,_json){
							$render500Err(_transport,_json);
							FloatPanel.close();
					});
					return false;
				}
			});
			return false;
		}
		*/
		var oHelper = new com.trs.web2frame.BasicDataHelper();
		oHelper.Call('wcm6_viewdocument',sQuoteType,oPostData,true,
			function(_transport,_json){
			if(_json!=null&&_json["REPORTS"]){
								var oReports = _json["REPORTS"];
								var stJson = com.trs.util.JSON;
								var bIsSuccess = stJson.value(oReports, "IS_SUCCESS");
								var title = stJson.value(oReports, "TITLE");
								if(bIsSuccess=='true'){
									if(title.indexOf("文档") != -1){
										oReports.TITLE.NODEVALUE = oReports.TITLE.NODEVALUE.replace(new RegExp(wcm.LANG.PUBLISH_6 || "文档","g"),wcm.LANG.PUBLISH_8 || "视频");
										if(oReports.REPORT.length){
											for(var i =0;i< oReports.REPORT.length;i++){
												var currItem = stJson.value(oReports.REPORT[i], "TITLE");
												if( currItem != null)
													oReports.REPORT[i].TITLE = currItem.replace(new RegExp(wcm.LANG.PUBLISH_6 || "文档","g"),wcm.LANG.PUBLISH_8 || "视频");
											}
										}else{
											oReports.REPORT.TITLE.NODEVALUE = oReports.REPORT.TITLE.NODEVALUE.replace(new RegExp(wcm.LANG.PUBLISH_6 || "文档","g"),wcm.LANG.PUBLISH_8 || "视频");
										}
									}
										Ext.Msg.report(_json,'视频引用结果',func);
										setTimeout(function(){CMSObj.createFrom({objType:WCMConstants.OBJ_TYPE_CHNLDOC}, null).afterdelete();},1000);
										FloatPanel.hide();
								}else{
									if(title.indexOf("文档") != -1){
										oReports.TITLE.NODEVALUE = oReports.TITLE.NODEVALUE.replace(new RegExp(wcm.LANG.PUBLISH_6 || "文档","g"),wcm.LANG.PUBLISH_8 || "视频");
										if(oReports.REPORT.length){
											for(var i =0;i< oReports.REPORT.length;i++){
												var currItem = stJson.value(oReports.REPORT[i], "TITLE");
												if( currItem != null)
													oReports.REPORT[i].TITLE = currItem.replace(new RegExp(wcm.LANG.PUBLISH_6 || "文档","g"),wcm.LANG.PUBLISH_8 || "视频");
											}
										}else{
											oReports.REPORT.TITLE.NODEVALUE = oReports.REPORT.TITLE.NODEVALUE.replace(new RegExp(wcm.LANG.PUBLISH_6 || "文档","g"),wcm.LANG.PUBLISH_8 || "视频");
										}
									}
										Ext.Msg.report(_json,'视频引用结果',func);
										setTimeout(function(){CMSObj.createFrom({objType:WCMConstants.OBJ_TYPE_CHNLDOC}, null).afterdelete();},1000);
										FloatPanel.hide();
								}
							}
						},
			function(_transport,_json){
				$render500Err(_transport,_json);
				FloatPanel.close();
			}
		);
		return false;
	}

	function changeViewer(_i){
		switch(parseInt(_i)){
			case 1:
				Element.show($('cluster_channels_list'));
				Element.hide($('all_channels_tree'));
				break;
			case 2:
				Element.hide($('cluster_channels_list'));
				Element.show($('all_channels_tree'));
				break;
		}
	}

	function getQuoteType(){
		var eQuoteTypes = document.getElementsByName("QuoteType");
		for(var i=0;i<eQuoteTypes.length;i++){
			if(eQuoteTypes[i].checked){
				return eQuoteTypes[i].value;
			}
		}
		return 'quote';
	}
</SCRIPT>
<style type="text/css">
	.iframe_container{
		width:370px;
		height:300px;
		padding:10px;
	}
	.font_red{
		color:red;
	}
</style>
</HEAD>

<BODY>
<DIV style="line-height:36px; height:36px;text-align:center;font-size:14px;color:#010101;border-bottom:1px solid gray;">
	<SPAN>
		<INPUT type="radio" name="mode" onclick="changeViewer(this.value)" value="1"><span WCMAnt:param="document_quoteto.html.clusterChnl">聚合栏目</span>
	</SPAN>
	<SPAN>
		<INPUT type="radio" name="mode" onclick="changeViewer(this.value)" checked value="2"><span WCMAnt:param="document_quoteto.html.allChnl">所有栏目</span>
	</SPAN>
</DIV>
<DIV id="all_channels_tree" class="iframe_container">
	<DIV style="height:100%;">
		<iframe id="allTreeNav" src="../include/blank.html" style="width:100%;height:100%" frameborder="0"  allowtransparency="true"></iframe>
	</DIV>
</DIV>
<DIV id="cluster_channels_list" class="iframe_container" style="display:none">
	<DIV style="height:100%;">
		<iframe id="clusterList" src="../include/blank.html" style="width:100%;height:100%" frameborder="0"  allowtransparency="true"></iframe>
	</DIV>
</DIV>
<DIV style="font-size:12px;">
	<INPUT TYPE="radio" id="QuoteType1" NAME="QuoteType" checked value="quote"><label for="QuoteType1" WCMAnt:param="document_quoteto.html.videolinktypeQuoteonlygenerateonlink">1.链接型引用（仅仅产生一个链接，视频表现形式保持完全一致）</label><BR>
	<INPUT TYPE="radio" id="QuoteType2" NAME="QuoteType" value="mirror"><label for="QuoteType2" WCMAnt:param="document_quoteto.html.mirrQuotevideotargetchnl">2.镜像型引用（在目标栏目产生视频的镜像）</label>
	<BR>
	<SPAN class="font_red" WCMAnt:param="document_quoteto.html.alertMessage">
	&nbsp;&nbsp;注意：如果选择镜像型引用时的目标栏目类型为头条新闻或图片新闻，则处理逻辑同链接型引用。
	</SPAN>
</DIV>
<script language="javascript">
<!--
	//var sURL = "?IsRadio=0&MultiSites=1&ExcludeSelf=1&ExcludeOnlySearch=1&RightIndex=31&ShowOneType=1";
	//当栏目是表单栏目的时候
	var nExcludeInfoView = 1;
	if(channelType.indexOf("13")>=0) nExcludeInfoView = 0;
	var sURL = "?IsRadio=0&MultiSites=1&ExcludeSelf=1&ExcludeOnlySearch=1&RightIndex=31&SiteTypes=2&MultiSiteType=0&ExcludeInfoView=" + nExcludeInfoView;
	//gfc 来自于不同栏目
	if(sChannelIds != null && sChannelIds != ''){
		var arChnlIds = sChannelIds.split(',');
		if(arChnlIds.length == 1) {
			sURL += "&CurrChannelId=" + arChnlIds[0];
		}else if(arChnlIds.length > 1) {
			sURL  += "&NotSelect=1&SelectedChannelIds="+sChannelIds; //TODO
		}
	}

	var sExpandSiteId = getParameter("siteids");
	if(sExpandSiteId != null && sExpandSiteId.length>0 && sExpandSiteId != "0"){
		sURL += "&ExpandSiteId="+sExpandSiteId;
	}

	$('allTreeNav').src = "../nav_tree/nav_tree_select.jsp"+sURL;
	//$('customizeTreeNav').src = "../nav_tree/nav_tree_select_individual.jsp"+sURL;
//-->
</script>
</BODY>
</HTML>