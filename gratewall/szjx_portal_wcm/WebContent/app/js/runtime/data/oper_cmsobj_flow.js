Ext.apply(wcm.LANG,{
FLOW : '工作流',
FLOW_CONFIRM : '确定',
FLOW_CLOSE : '关闭',
FLOW_SAVE :'保存',
FLOW_CANCEL : '取消',
FLOW_REFRESH : '刷新',
FLOW_0 : '确实要取消该栏目上的工作流分配吗',
FLOW_1 : '确实要取消所选栏目上的工作流分配吗',
FLOW_2 : '个',
FLOW_3 : '栏目',
FLOW_EDIT : '编辑;',
FLOW_DELETE1 : "删除",
FLOW_PUBLISH : "发布;",
FLOW_4 : "您输入的工作流名称不能包含以下特殊字符 ",
FLOW_5 : '正在保存工作流..',
FLOW_6 : '工作流保存成功！',
FLOW_7 : '工作流保存结果',
FLOW_8 : '无表单可供选择',
FLOW_9 :'您当前使用的浏览器不支持TRSWCM工作流编辑器！\n\n请检查：\n'
+ '1.浏览器为IE5+；\n'
+ '2.已从服务器端下载并正确安装了Activex控件，同时该Activex已正常启用；\n'
+ '3.已将当前站点设置为信任站点。',
FLOW_START : '开始',
FLOW_FINISH : '结束',
FLOW_OPER : '操作:',
FLOW_NODE : '节点',
FLOW_DESC : '描述:',
FLOW_NEWSTATUS : '新稿状态',
FOLW_LIST : '工作流列表',
FLOW_NAME : '工作流名称',
FLOW_DESC : '工作流描述',
SELECT_CRUSER : '创建者',
FLOW_ID : '工作流ID',
FLOW_10 : '您输入的工作流名称不能包含以下特殊字符 ',
FLOW_11 : '定义工作流规则',
FLOW_12 : '返回属性页面',
FLOW_START_DEFINE : '开始规则定义',
RETURN_VALUE_FALSE : '返回值不正确！',
GROUP : '(分组) ',
VIEW : '(视图) ',
VARIABLE : '(变量)',
NONE : '(无)',
NONE_1 : '无',
INIT_VALUE : '初始值: ',
FLOW_13 : '您输入的节点名称不能包含以下特殊字符 ',
FLOW_14 : '您输入的节点描述不能包含以下特殊字符 ',
FLOW_15 : '请指定用户组织或部门！',
FLOW_16 : '请指定用户！',
FLOW_17 : '请填写表单字段名！',
FLOW_18 : '节点已经存在!',
CONDITION : '\n条件: ',
NOPER : '\n操作: ',
OPER_RULE : '新建/修改规则',
ADD_CONDITION : '增加条件', 
ADD_OPER : '增加操作',
FLOW_19 : '确认要删除此规则吗？',
FLOW_20 : '确认要删除此条件吗？',
FLOW_21 : '确认要删除此操作吗？',
FLOW_22 : '配置信息错误。没有指定条件的参数！',
FLOW_23 : '请选择要设置的栏目！',
FLOW_24 : '设置成功！',
FLOW_25 : '当前工作流的某些属性可能已经修改，是否保存？',
FLOW_26 : '执行进度，请稍候...',
FLOW_27 : '正在导入工作流..',
FLOW_28 : '成功导入工作流!',
FLOW_29 : '文件路径为空，上传失败！',
FLOW_30 : '工作流导入结果',
FLOW_31 : '未知',
FLOW_FINISH_PROCESS :'结束流转',
FLOW_ADD_EDIT : '新建/修改工作流',
FLOW_EMPLOYEE : '分配流程',
FLOW_IMPORT : '工作流导入',
FLOW_32 : '系统提示信息',
FLOW_33 : '没有任何要操作的工作流！',
FLOW_34 : '确实要取消该栏目上的流程吗? ',
FLOW_EXPORT : '导出这个工作流',
FLOW_35 : '将当前工作流以xml文件导出',
FLOW_ADD : '新建工作流',
FLOW_36 : '新建工作流并分配到当前栏目',
FLOW_SET : '设置工作流',
FLOW_EDIT : '编辑这个工作流',
FLOW_DELETE : '删除这个工作流',
FLOW_ASSIGN : '分配这个工作流到栏目',
FLOW_37 : '导入工作流',
FLOW_38 : '从外部导入工作流',
FLOWS_DELETE : '删除这些工作流',
FLOWS_EXPORT : '导出这些工作流',
FLOW_39 : '将当前工作流以xml文件导出',
FLOW_40 : '没有找到关于[condition]的配置定义！',
FLOW_41 : '参数值',
FLOW_42 : '由于该[条件]尚未提交，此举将把您刚刚新建的这个[条件]移除！\n\n(提示：点击”取消“可以回到[条件]编辑页)',
FLOW_43 : '没有找到关于[action]的配置定义！',
FLOW_44 : '[action]没有被初始化！\n',
FLOW_45 : '由于该[操作]尚未提交，此举将把您刚刚新建的这个[操作]移除！\n\n(提示：点击”取消“可以回到[操作]编辑页)',
FLOW_CANCEL_USE : '取消分配',
FLOW_46 : '递归显示',
FLOW_47 : '仅显示当前',
FLOW_48 : '请选择一个工作流或者点击取消选择',
FLOW_49 : '确实要取消所选栏目上的工作流分配吗?',
FLOW_50 : '新建',
FLOW_51 : '请选择要删除的工作流',
FLOW_52 : '删除这个/些工作流',
FLOW_53 : '刷新列表',
FLOW_54 : '工作流列表管理',
FLOW_55 : '设置',
FLOW_56 : '栏目工作流配置',
FLOW_57 : '请选择要取消的栏目',
FLOW_58 : '确实要取消这些栏目上的流程吗? ',
FLOW_59 : '配置该工作流的栏目列表',
FLOW_60 : '选择工作流',
FLOW_61 : '点击切换递归显示所有工作流&#13;当前为: 递归显示',
FLOW_62 : "点击切换递归显示所有工作流&#13;当前为: ",
FLOW_63 : '收到前',
FLOW_64 : '收到后',
FLOW_65 : '签收后',
FLOW_66 : '处理中',
FLOW_67 : '处理后',
FLOW_68 : '要求返工后',
FLOW_69 : '拒绝后',
FLOW_70 : '分配工作流',
FLOW_71 : '无法获取当前栏目[ID=',
FLOW_72 : ']所属站点的信息！',
FLOW_73 : '点击转到大的编辑区域',
FLOW_74 : '编辑参数',
FLOW_75 : '操作标签名称的长度不能大于50',
FLOW_76 : '导入',
FLOW_77 : '编辑',
FLOW_78 : '导出',
FLOW_79 : '导出这个/些工作流',
FLOW_80 : '分配',
FLOW_81 : '分配这个工作流到栏目',
FLOW_82 : '您输入的操作名称不能包含以下特殊字符',
FLOW_83 : '您输入的操作标签名称不能包含以下特殊字符',
FLOW_84 : '点击切换递归显示所有工作流\n当前为:',
FLOW_85 :　'',
FLOW_86 : '请指定用户角色！',
FLOW_87 : '点击切换到OR',
FLOW_88 : '点击切换到AND'
});

Ext.ns('wcm.domain.FlowMgr');
(function(){
var m_oFlowMgr = wcm.domain.FlowMgr;
var serviceId = 'wcm6_process';
function __checkNoRecords(_oHostInfos){
if(_oHostInfos.num <= 0) {
Ext.Msg.$fail(wcm.LANG['FLOW_33'] || '没有任何要操作的工作流！');
return false;
}
return true;
}
function setFlowCallBack(_args){
var nFlowId = _args['FlowId'];
var nOldFlowId = _args['nOldFlowId'];
if(_args['disabled'] == true && nOldFlowId != 0){
BasicDataHelper.call('wcm6_process','disableFlowToChannel',{ObjectId:_args['ChannelId'],FlowId: 0},true,function(_transport,_json){
$MsgCenter.$main().afteredit();
});
}else if(nFlowId != nOldFlowId){
BasicDataHelper.call('wcm6_process','enableFlowToChannel',{ObjectId:_args['ChannelId'],FlowId:nFlowId},true,function(_transport,_json){
$MsgCenter.$main().afteredit();
});
}
}
function assignFlowCallBack(m_nFlowId){
return function (sSelIds){
if(sSelIds.length == 0) {
Ext.Msg.$fail(wcm.LANG['FLOW_23'] || '请选择要设置的栏目！');
return false;
}
var params = {ObjectIds:sSelIds.join(','),FlowId:m_nFlowId};
BasicDataHelper.call('wcm6_process','setChannelEmployersOfFlow',params,true,function(_transport,_json){
Ext.Msg.$timeAlert((wcm.LANG['FLOW_24'] || '设置成功！'), 3);
FloatPanel.close();
});
return false;
}
}
function _addEditCallBack(event,addOrEdit){
var arrIds = event.getIds();
var host = event.getHost();
var flowObj = event.getObjs().getAt(0);
var nLoadView = 1;
if(flowObj!=null && wcm.AuthServer.hasRight(flowObj.right, 42)){
nLoadView = 2;
}
else if(flowObj==null && wcm.AuthServer.hasRight(host.right, 41)){
nLoadView = 2;
}
if(addOrEdit==0){
var o_params = {
FlowId : 0,
LoadView : nLoadView,
OwnerType : host.getIntType(),
OwnerId : host.getId(),
ShowButtons : '0'
}
}
else {
var o_params = {
FlowId : event.getIds().join(),
LoadView : nLoadView,
OwnerType : host.getIntType(),
OwnerId : host.getId(),
ShowButtons : '0'
}
}
}
function _addEdit(event, addOrEdit, params){
var arrIds = event.getIds();
var host = event.getHost();
var flowObj = event.getObjs().getAt(0);
var nLoadView = 1;
if(flowObj!=null && wcm.AuthServer.hasRight(flowObj.right, 42)){
nLoadView = 2;
}
else if(flowObj==null && wcm.AuthServer.hasRight(host.right, 41)){
nLoadView = 2;
}
if(addOrEdit==0){
var o_params = {
FlowId : 0,
LoadView : nLoadView,
OwnerType : host.getIntType(),
OwnerId : host.getId(),
ShowButtons : '0'
}
}
else {
var o_params = {
FlowId : event.getIds().join(),
LoadView : nLoadView,
OwnerType : host.getIntType(),
OwnerId : host.getId(),
ShowButtons : '0'
}
}
Ext.apply(o_params, params||{});
wcm.Flow_AddEdit_Selector._addEditFlow(o_params, function flowAddeditCallBack(_args){
var event = this;
var fnEvent = addOrEdit==0 ? CMSObj.afteradd(event)
: CMSObj.afteredit(event);
var host = event.getHost();
if(host.getIntType()==101
&& _args['id'] > 0) {
BasicDataHelper.call('wcm6_process', 'enableFlowToChannel', {
ObjectId: host.getId(),
FlowId: _args['id']
}, false, function(_transport, _json){
fnEvent(_args['id']);
}
);
}else{
fnEvent(_args['id']);
}
}.bind(event));
}
Ext.apply(wcm.domain.FlowMgr, {
add : function(event){
_addEdit(event,0);
},
edit : function(event){
_addEdit(event,1);
},
view : function(event){
_addEdit(event,1,{readonly:true});
},
assign : function(event){
var context = event.getContext();
var currObj = event.getObjs().getAt(0);
var m_nFlowId = currObj.getId();
Object.extend(context, {FlowId : event.getIds().join()});
var params = {
IsRadio : 0,
ExcludeTop : 1,
ExcludeLink : 1,
ShowOneType : 1,
MultiSites : 0,
RightIndex : 42,
ExcludeInfoview : 0,
ExcludeOnlySearch : 1
}
BasicDataHelper.call('wcm6_process','getChannelsUseingFlow',{ObjectId:m_nFlowId,OnlyReturnIds:true,IdsValueType:0},false,function(_transport,_json){
var ids = _transport.responseText||'';
if(ids.trim().length > 0){
Object.extend(params,{SELECTEDCHANNELIDS : ids});
}
var nFlowOwnerType = currObj.getPropertyAsInt('ownerType' ,0);
var nFlowOwnerId = currObj.getPropertyAsInt('ownerId' ,0);
if(nFlowOwnerType == 103){
Object.extend(params,{MultiSites : 0,
CurrSiteId : context.siteid || nFlowOwnerId
});
}else if(nFlowOwnerType == 101){
Object.extend(params,{MultiSites : 0});
if(context.siteid)
Object.extend(params,{CurrSiteId : context.siteid});
}else{
Object.extend(params,{SiteTypes : nFlowOwnerId,CurrSiteType : context.sitetype || nFlowOwnerId});
}
var currSiteType = event.getContext().get("siteType") || 0 ;
Object.extend(params,{CurrSiteType:currSiteType,MultiSites : 0});
var currHostType = event.getHost().getProperty('objType');//获得当前工作流对象的上级对象的objType属性
if(currHostType == "channel"){
Object.extend(params,{SiteTypes:currSiteType,MultiSites : 0});
}
FloatPanel.open({
src : WCMConstants.WCM6_PATH + 'include/channel_select.html',
title : wcm.LANG['FLOW_70'] || '分配工作流',
callback : assignFlowCallBack(m_nFlowId),
dialogArguments : params
});
});
},
'import' : function(event){
var context = event.getContext();
var params = {
OwnerId: context.OwnerId,
OwnerType: context.OwnerType
}
FloatPanel.open(WCMConstants.WCM6_PATH + 'flow/flow_import.html?' + $toQueryStr(params), 
wcm.LANG['FLOW_IMPORT'] ||'工作流导入', CMSObj.afteradd(event));
},
'export' : function(event){
if(!__checkNoRecords(event.getContext())) {
return;
}
var oPostData = {
objectIds: event.getIds().join()
};
BasicDataHelper.call(serviceId, 'exportFlows', oPostData, true, function(_trans, _json){
var sFileUrl = _trans.responseText;
var frm = document.getElementById("ifrmDownload");
if(frm == null) {
frm = document.createElement('iframe');
frm.style.height = 0;
frm.style.width = 0;
document.body.appendChild(frm);
}
sFileUrl = WCMConstants.WCM6_PATH + "file/read_file.jsp?DownName=" + sFileUrl + "&FileName=" + sFileUrl;
frm.src = sFileUrl;
}.bind(this));
},
'delete' : function(event){
var o_params = {
objectids : event.getIds().join()
}
var sUrl = WCMConstants.WCM6_PATH + 'flow/workflow_employment_info.jsp';
wcm.CrashBoarder.get('workflow_info_dialog').show({
title : wcm.LANG['FLOW_32'] || '系统提示信息',
reloadable : true,
src : sUrl,
width: '450px',
height: '220px',
params : o_params,
maskable : true,
callback : function(){
var event = this;
var host = event.getHost();
BasicDataHelper.call(serviceId,'delete', Object.extend(o_params,{
'ObjectIds': event.getIds().join(), 
'drop': true
}), 
true, 
function(){
CMSObj.afterdelete(event)();
});
return false;
}.bind(event)
});
},
setemployer : function(event){
var id = event.getIds().join()|| 0;
var context = event.getContext();
var host = event.getHost();
var params = {
OwnerType: context.OwnerType,
OwnerId: context.OwnerId,
ChannelId: host.getId(),
CurrFlowId: id
};
wcm.Flow_AddEdit_Selector.selectFlow(params,setFlowCallBack);
}
});
})();
(function(){
var pageObjMgr = wcm.domain.FlowMgr;
var reg = wcm.SysOpers.register;
reg({
key : 'add',
type : 'flowInChannel',
isHost : true,
desc : wcm.LANG['FLOW_ADD'] || '新建工作流',
title:'新建工作流',
rightIndex : 41,
order : 2,
fn : pageObjMgr['add'],
quickKey : 'N'
});
reg({
key : 'setemployer',
type : 'flowInChannel',
isHost : true,
desc : wcm.LANG['FLOW_SET'] || '设置工作流',
title:'设置工作流',
rightIndex : 13,
order : 3,
fn : pageObjMgr['setemployer']
});
reg({
key : 'edit',
type : 'flow',
desc : wcm.LANG['FLOW_EDIT'] || '编辑这个工作流',
title:'编辑这个工作流',
rightIndex : 42,
order : 4,
fn : pageObjMgr['edit'],
isVisible : function(event){
var host = event.getHost();
if(host.getType()==WCMConstants.OBJ_TYPE_CHANNEL){
return false;
}
return true;
},
quickKey : 'M'
});
reg({
key : 'delete',
type : 'flow',
desc : wcm.LANG['FLOW_DELETE'] || '删除这个工作流',
title:'删除这个工作流',
rightIndex : 43,
order : 5,
fn : pageObjMgr['delete'],
isVisible : function(event){
var host = event.getHost();
if(host.getType()==WCMConstants.OBJ_TYPE_CHANNEL){
return false;
}
return true;
},
quickKey : ['Delete', 'ShiftDelete']
});
reg({
key : 'assign',
type : 'flow',
desc : wcm.LANG['FLOW_ASSIGN'] || '分配这个工作流到栏目',
title:'分配这个工作流到栏目',
rightIndex : 42,
order : 6,
fn : pageObjMgr['assign']
});
reg({
key : 'export',
type : 'flow',
desc : wcm.LANG['FLOW_EXPORT'] ||'导出这个工作流',
title:'导出这个工作流',
rightIndex : 44,
order : 7,
fn : pageObjMgr['export'],
quickKey : 'X'
});
reg({
key : 'add',
type : 'flowInSite',
isHost : true,
desc : wcm.LANG['FLOW_ADD'] || '新建工作流',
title:'新建工作流',
rightIndex : 41,
order : 8,
fn : pageObjMgr['add'],
quickKey : 'N'
});
reg({
key : 'import',
type : 'flowInSite',
isHost : true,
desc : wcm.LANG['FLOW_37'] || '导入工作流',
title:'导入工作流',
rightIndex : 45,
order : 9,
fn : pageObjMgr['import'],
quickKey : 'I'
});
reg({
key : 'add',
type : 'flowInSys',
isHost : true,
desc : wcm.LANG['FLOW_ADD'] || '新建工作流',
title:'新建工作流',
rightIndex : 41,
order : 10,
fn : pageObjMgr['add'],
quickKey : 'N'
});
reg({
key : 'import',
type : 'flowInSys',
isHost : true,
desc : wcm.LANG['FLOW_37'] || '导入工作流',
title:'导入工作流',
rightIndex : 45,
order : 11,
fn : pageObjMgr['import'],
quickKey : 'I'
});
reg({
key : 'delete',
type : 'flows',
desc : wcm.LANG['FLOWS_DELETE'] || '删除这些工作流',
title:'删除这些工作流',
rightIndex : 43,
order : 12,
fn : pageObjMgr['delete'],
quickKey : ['Delete', 'ShiftDelete']
});
reg({
key : 'export',
type : 'flows',
desc : wcm.LANG['FLOWS_EXPORT'] || '导出这些工作流',
title:'导出这些工作流',
rightIndex : 44,
order : 13,
fn : pageObjMgr['export'],
quickKey : 'X'
});
})();

Ext.ns('wcm.Flows', 'wcm.Flow');
WCMConstants.OBJ_TYPE_FLOW = 'flow';
wcm.Flows = function(_config, _context){
this.objType = WCMConstants.OBJ_TYPE_FLOW;
wcm.Flows.superclass.constructor.call(this, _config, _context);
}
Ext.extend(wcm.Flows, wcm.CMSObjs, {
});
wcm.Flow = function(_config, _context){
this.objType = WCMConstants.OBJ_TYPE_FLOW;
wcm.Flow.superclass.constructor.call(this, _config, _context);
var arrRights = {
"view" : -1
};
for(rightName in arrRights){
var cameRightName = rightName.camelize();
var nRightIndex = parseInt(arrRights[rightName], 10);
this['can'+cameRightName] = function(){
return wcm.AuthServer.hasRight(this.right, nRightIndex);
}
}
}
CMSObj.register(WCMConstants.OBJ_TYPE_FLOW, 'wcm.Flow');
Ext.extend(wcm.Flow, wcm.CMSObj, {
getIntType : function(){
return 401;
}
});

(function(){
var sName = wcm.LANG['FLOW'] || '工作流';
wcm.PageOper.registerPanels({
flowInSys : {
isHost : true,
title : String.format(wcm.LANG['OPER_TITLE_INROOT'] || '库{0}操作任务', sName),
displayNum : 5
},
flowInSite : {
isHost : true,
title : String.format(wcm.LANG['OPER_TITLE_INSITE'] || '站点{0}操作任务', sName),
displayNum : 5
},
flowInChannel : {
isHost : true,
title : String.format(wcm.LANG['OPER_TITLE_INCHANNEL'] || '栏目{0}操作任务', sName),
displayNum : 5
},
flow : {
title : String.format(wcm.LANG['OPER_TITLE_OBJ'] || '{0}操作任务', sName),
displayNum : 7,
url : '?serviceid=wcm61_flow&methodname=jFindbyid',
params : function(def, opt){
if(location.href.indexOf('flow_chnl_list.html')!=-1){
return 'FromChnl=1';
}
return '';
}
},
flows : {
title : String.format(wcm.LANG['OPER_TITLE_OBJ'] || '{0}操作任务', sName),
displayNum : 7
}
});
})();
ValidationHelper.bindValidations([
{
renderTo : 'flowName',
type:'string',
required:'',
max_len:'50',
desc: wcm.LANG['FLOW_NAME'] || '工作流名称',
methods : PageContext.validExistProperty()
}
]);

