Ext.apply(wcm.LANG,{
METAVIEWDATA_1 : '确定',
METAVIEWDATA_2 : '没选中任何模式',
METAVIEWDATA_3 : '请选择当前记录要复制到的目标栏目!',
METAVIEWDATA_4 : '执行进度',
METAVIEWDATA_5 : '提交数据',
METAVIEWDATA_6 : '成功执行完成',
METAVIEWDATA_7 : '记录复制结果',
METAVIEWDATA_8 : '栏目名称:',
METAVIEWDATA_9 : ',视图名称:',
METAVIEWDATA_10 : '源栏目和目标栏目使用的视图不一致,无法进行复制',
METAVIEWDATA_11 : '导出',
METAVIEWDATA_12 : '请选择要当前记录要移动到的目标栏目!',
METAVIEWDATA_13 : '不能将当前记录从当前栏目移动到自身!',
METAVIEWDATA_14 : '记录移动结果',
METAVIEWDATA_15 : '源栏目和目标栏目使用的视图不一致,无法进行移动',
METAVIEWDATA_16 : '请输入一个正整数.',
METAVIEWDATA_17 : '请选择当前文档要引用到的目标栏目!',
METAVIEWDATA_18 : '记录引用结果',
METAVIEWDATA_19 : '源栏目和目标栏目使用的视图不一致,无法进行引用',
METAVIEWDATA_20 : '导入',
METAVIEWDATA_21 : '记录导入结果',
METAVIEWDATA_22 : '尚未选择由TRS数据库导出的XML文件.',
METAVIEWDATA_23 : '未选择其他XML文件.',
METAVIEWDATA_24 : '管理TRS映射关系',
METAVIEWDATA_25 : '记录—改变位置到',
METAVIEWDATA_26 : '确实要将这',
METAVIEWDATA_27 : '条记录放入废稿箱吗? ',
METAVIEWDATA_28 : '删除进度',
METAVIEWDATA_29 : '删除',
METAVIEWDATA_30 : '删除数据结果',
METAVIEWDATA_31 : '记录-改变状态',
METAVIEWDATA_32 : '没有指定视图ID[VIEWID]',
METAVIEWDATA_33 : '导出记录',
METAVIEWDATA_34 : '设置数据同步到WCMDocument的规则',
METAVIEWDATA_35 : '导入记录',
METAVIEWDATA_36 : '引用记录',
METAVIEWDATA_38 : '复制记录',
METAVIEWDATA_39 : '移动记录',
METAVIEWDATA_40 : '改变记录顺序到',
METAVIEWDATA_41 : '修改这条记录',
METAVIEWDATA_42 : '预览这条记录',
METAVIEWDATA_43 : '预览这条记录发布效果',
METAVIEWDATA_44 : '发布这条记录',
METAVIEWDATA_45 : '发布这条记录，生成这条记录的细览页面以及更新相关概览页面',
METAVIEWDATA_46 : '仅发布这条记录细览',
METAVIEWDATA_47 : '仅发布这条记录细览，仅重新生成这条记录的细览页面',
METAVIEWDATA_48 : '撤销发布这条记录',
METAVIEWDATA_49 : '撤销发布这条记录，撤回已发布目录或页面',
METAVIEWDATA_50 : '导出这条记录',
METAVIEWDATA_51 : '将这条记录导出成zip文件',
METAVIEWDATA_52 : '分隔线',
METAVIEWDATA_53 : '改变这条记录状态',
METAVIEWDATA_54 : '移动这条记录到',
METAVIEWDATA_55 : '复制这条记录到',
METAVIEWDATA_56 : '引用这条记录到',
METAVIEWDATA_57 : '将记录放入废稿箱',
METAVIEWDATA_58 : '新建一条记录',
METAVIEWDATA_59 : '从外部导入记录',
METAVIEWDATA_60 : '从Excel创建记录',
METAVIEWDATA_61 : '设置同步规则',
METAVIEWDATA_62 : '设置同步到文档的规则',
METAVIEWDATA_63 : '预览这些记录',
METAVIEWDATA_64 : '预览这些记录发布效果',
METAVIEWDATA_65 : '发布这些记录',
METAVIEWDATA_66 : '发布这些记录，生成这些记录的细览页面以及更新相关概览页面',
METAVIEWDATA_67 : '仅发布这些记录细览',
METAVIEWDATA_68 : '仅发布这些记录细览，仅重新生成这些记录的细览页面',
METAVIEWDATA_69 : '撤销发布这些记录',
METAVIEWDATA_70 : '撤销发布这些记录，撤回已发布目录或页面',
METAVIEWDATA_71 : '导出这些记录',
METAVIEWDATA_72 : '将这些记录导出成zip文件',
METAVIEWDATA_73 : '改变这些记录状态',
METAVIEWDATA_74 : '移动这些记录到',
METAVIEWDATA_75 : '复制这些记录到',
METAVIEWDATA_76 : '引用这些记录到',
METAVIEWDATA_77 : '新建',
METAVIEWDATA_78 : '删除',
METAVIEWDATA_79 : '预览',
METAVIEWDATA_80 : '快速发布',
METAVIEWDATA_81 : '移动',
METAVIEWDATA_82 : '复制',
METAVIEWDATA_83 : '引用',
METAVIEWDATA_84 : '刷新',
METAVIEWDATA_85 : '刷新列表',
METAVIEWDATA_86 : '资源列表管理',
METAVIEWDATA_87 : '查看记录',
METAVIEWDATA_88 : '已经复制到剪切板中！',
METAVIEWDATA_89 : '您的浏览器不支持自动复制操作',
METAVIEWDATA_90 : '没有设置字段的分类法信息！',
METAVIEWDATA_91 : '未知的变量类型',
METAVIEWDATA_92 : '未选择',
METAVIEWDATA_93 : '检索',
METAVIEWDATA_94 : '信息',
METAVIEWDATA_95 : '附件管理',
METAVIEWDATA_96 : '简易编辑器',
METAVIEWDATA_97 : '选择数据',
METAVIEWDATA_98 : '没有加载完成',
METAVIEWDATA_99 : '非法数据',
METAVIEWDATA_100 : '保存',
METAVIEWDATA_101 : '关闭',
METAVIEWDATA_102 : '个',
METAVIEWDATA_103 : '资源',
METAVIEWDATA_104 :'创建者',
METAVIEWDATA_105 : '高级检索',
METAVIEWDATA_106 : '修改',
METAVIEWDATA_107 : '取消',
METAVIEWDATA_108 : '记录',
METAVIEWDATA_109 : '上传文件失败！',
METAVIEWDATA_110 : '导出所有记录',
METAVIEWDATA_111 : '此操作可能需要较长时间。确实要导出所有记录吗？',
METAVIEWDATA_112 : '记录-导出所有记录',
METAVIEWDATA_113 : '批量修改',
METAVIEWDATA_114 : '提交数据',
METAVIEWDATA_115 : '开始时间大于结束时间，请重新输入.',
METAVIEWDATA_116 : '不能为空.',
METAVIEWDATA_117 : '设置这条记录权限',
METAVIEWDATA_118 : '序号',
METAVIEWDATA_119 : '文档标题',
METAVIEWDATA_120 : '排序',
METAVIEWDATA_121 : '--当前文档--',
METAVIEWDATA_122 : '上移',
METAVIEWDATA_123 : '下移',
METAVIEWDATA_124 : '请先在视图中设置分类法',
METAVIEWDATA_125 : '分类法id可能被修改过，请注意',
METAVIEWDATA_126 : '新建记录',
METAVIEWDATA_127 : 'DocTitle和DocContent值加起来不要超过500字节.请尽量简短.',
METAVIEWDATA_128 : '请选择导出字段.',
METAVIEWDATA_129 : '删除记录',
METAVIEWDATA_130 : "确定要<font color='red' style='font-size:14px;'>撤销发布</font>所选记录么？将<font color='red' style='font-size:14px;'>不可逆转</font>！",
FILTER_METAVIEWDATA_ALL : '全部资源',
METAVIEWDATA_131 : '直接发布这条记录',
METAVIEWDATA_132 : '发布这条记录细览，同时发布此记录的所有引用记录',
METAVIEWDATA_133 : '直接撤销发布这条记录',
METAVIEWDATA_134 : '撤回当前记录的发布页面，并同步撤销记录的所有引用以及原记录发布页面',
METAVIEWDATA_135 : '直接发布这些记录',
METAVIEWDATA_136 : '发布这些记录细览，同时发布这些记录的所有引用记录',
METAVIEWDATA_137 : '直接撤销发布这些记录',
METAVIEWDATA_138 : '撤回这些记录的发布页面，并同步撤销记录的所有引用以及原记录发布页面',
METAVIEWDATA_139 : "确定要<font color='red' style='font-size:14px;'>撤销发布</font>所选记录及其所有引用记录么？将<font color='red' style='font-size:14px;'>不可逆转</font>！"
});

Ext.ns('wcm.domain.MetaViewDataMgr');
(function(){
var m_oMgr = wcm.domain.MetaViewDataMgr;
function getHelper(){
return new com.trs.web2frame.BasicDataHelper();
}
function parseHost(host){
if(host.getType()==WCMConstants.OBJ_TYPE_CHANNEL){
return {ChannelId:host.getId(),SiteId:0};
}
if(host.getType()==WCMConstants.OBJ_TYPE_WEBSITE){
return {SiteId:host.getId(),ChannelId:0};
}
return {};
}
function doOptionsAfterDisplayInfo(_params, _fDoAfterDisp){
var DIALOG_DOCUMENT_INFO = 'document_info_dialog';
wcm.CrashBoarder.get('DIALOG_DOCUMENT_INFO').show({
title : wcm.LANG.DOCUMENT_PROCESS_208 || '系统提示信息',
src : WCMConstants.WCM6_PATH + 'docrecycle/document_info.html',
width:'500px',
height:'205px',
maskable:true,
params : _params,
callback : _fDoAfterDisp
});
}
function _addEdit(_id,event){
var nObjId = _id || 0;
var sTitle = (nObjId == 0)?(wcm.LANG.METAVIEWDATA_77 || "新建"):(wcm.LANG.METAVIEWDATA_106 || "修改");
sTitle += (wcm.LANG.METAVIEWDATA_108 || "记录");
var contextParams = event.getContext().params;
var nViewId = event.getObj().getPropertyAsInt("viewid",0)||contextParams.VIEWID||0;
var oParams = {
ObjectId:nObjId,
ChannelId:(nObjId == 0) ? event.getHost().getId() 
: event.getObj().getPropertyAsInt("currchnlid",0),
ChnlDocId:event.getObj().getPropertyAsInt("recid",0),
FlowDocId:contextParams.FlowDocId || 0,
ViewId:nViewId
};
$openMaxWin(WCMConstants.WCM6_PATH + './application/' + nViewId + '/metaviewdata_addedit.jsp?' + $toQueryStr2(oParams));
}
Ext.apply(wcm.domain.MetaViewDataMgr, {
view : function(event){
var _objId = event.getObj().getPropertyAsInt("docid",0);
var nViewId = event.getObj().getPropertyAsInt("dockind",0) || event.getContext().params["VIEWID"];
var urlParams = "?objectId=" + _objId;
var url = WCMConstants.WCM6_PATH + "application/" + nViewId + "/viewdata_detail.jsp" + urlParams;
$openMaxWin(url);
},
docpositionset : function(event){
var oPageParams = {};
var host = event.getHost();
var hostid = host.getId();
var docid = event.getObj().getPropertyAsInt("docid",0);
Object.extend(oPageParams,host.getType()=="website"?{"siteid" : hostid}:{"channelid" : hostid});
Object.extend(oPageParams,{"DocumentId":docid});
FloatPanel.open(WCMConstants.WCM6_PATH + 'metaviewdata/record_position_set.jsp?' + $toQueryStr(oPageParams), (wcm.LANG.METAVIEWDATA_25 || '记录—改变位置到'), CMSObj.afteredit(event));
},
preview : function(event){
var host = event.getHost();
var hostid = host.getId();
var oParams = {
FolderId : hostid,
FolderType : host.getType()=="website"? 103:101
};
var sIds = event.getIds().join(',');
wcm.domain.PublishAndPreviewMgr.preview(sIds,600,oParams,"wcm6_viewdocument");
},
basicpublish : function(event){
publish(event,"basicPublish");
},
recallpublish : function(event){
var sHtml = (wcm.LANG.METAVIEWDATA_130 ||"确定要<font color=\'red\' style=\'font-size:14px;\'>撤销发布</font>所选记录么？将<font color=\'red\ style=\'font-size:14px;\'>不可逆转</font>");
Ext.Msg.confirm(sHtml,{
yes : function(){
publish(event,'recallPublish');
}
});
},
detailpublish : function(event){
publish(event,'detailPublish');
},
directpublish : function(event){
var oPageParams = event.getContext();
var _sIds = event.getIds();
var postData = Object.extend({},{
'ObjectIds' : _sIds
});
BasicDataHelper.call("wcm6_viewdocument", "directpublish", postData, true, function(_transport,_json){
wcm.domain.PublishAndPreviewMgr.doAfterPublish(postData, "detailpublish",_transport,_json);
}.bind(this));
},
directRecallpublish : function(event){
var sHtml = (wcm.LANG.METAVIEWDATA_139 ||"确定要<font color=\'red\' style=\'font-size:14px;\'>撤销发布</font>所选记录及其所有引用记录么？将<font color=\'red\' style=\'font-size:14px;\'>不可逆转</font>");
Ext.Msg.confirm(sHtml,{
yes : function(){
publish(event, 'recallpublishall');
}
})
},
"delete" : function(event){
var oHost = parseHost(event.getHost());
var browserEvent = event.browserEvent;
var bDrop = !!(browserEvent && 
browserEvent.type=='keydown' && browserEvent.shiftKey);
var params = {
objectids: event.getIds(),
operation: bDrop ? '_forcedelete' : '_trash'
}
doOptionsAfterDisplayInfo(params, function(){
ProcessBar.start(wcm.LANG.DOCUMENT_PROCESS_123||'删除记录');
getHelper().call('wcm6_viewdocument', 'delete',
Ext.apply(oHost,{"ObjectIds": event.getIds(), "drop": bDrop}), true, 
function(){
ProcessBar.close();
event.getObjs().afterdelete();
}
);
});
},
changestatus : function(event){
var oPageParams = event.getContext();
var host = event.getHost();
var hostid = host.getId();
var _sObjectIds = event.getIds().join(',');
Object.extend(oPageParams,{"ObjectIds":_sObjectIds,"IsPhoto":false,'ChannelIds':(oPageParams,host.getType()=="website"?0:hostid)});
FloatPanel.open(WCMConstants.WCM6_PATH +'document/change_status.jsp?' + $toQueryStr(oPageParams), (wcm.LANG.METAVIEWDATA_31 || '记录-改变状态'), CMSObj.afteredit(event));
},
changelevel : function(event){
var oPageParams = event.getContext();
var host = event.getHost();
var hostid = host.getId();
var _sObjectIds = event.getObjs().getPropertys("docId").join(',');
Object.extend(oPageParams,{
"ObjectIds":_sObjectIds,
"IsPhoto":false});
FloatPanel.open(WCMConstants.WCM6_PATH +'document/change_doclevel.jsp?' + $toQueryStr(oPageParams), '记录-改变密级', CMSObj.afteredit(event));
},
"export" : function(event){
var _nViewId = event.getObj().getProperty('dockind');
_nViewId = _nViewId || event.getContext().params["VIEWID"];
var _chnlId = event.getContext().params["CHANNELID"];
var _sObjectIds = event.getObjs().getPropertys("docId").join(',');
try{
if(!_nViewId){
Ext.Msg.alert(wcm.LANG.METAVIEWDATA_32 || "没有指定视图ID[VIEWID]");
return;
}
}catch(error){
Ext.Msg.alert("metaviewdata.export:" + error.message);
}
FloatPanel.open( WCMConstants.WCM6_PATH +'metaviewdata/record_export.jsp?' + $toQueryStr({
viewId : _nViewId,
channelId : _chnlId,
ObjectIds : _sObjectIds
}), (wcm.LANG.METAVIEWDATA_33 || '导出记录'), CMSObj.afteredit(event));
return;
},
setsynrule : function(event){
var channelId = event.getHost().getId();
FloatPanel.open( WCMConstants.WCM6_PATH + 'metaviewdata/syn_rule_set.html?synRuleSetFrom=channel&channelId=' + channelId, (wcm.LANG.METAVIEWDATA_34 || '设置数据同步到WCMDocument的规则'), CMSObj.afteredit(event));
},
createfromexcel : function(event){
var _nViewId = event.getContext().params["VIEWID"];
try{
if(!_nViewId){
Ext.Msg.alert(wcm.LANG.METAVIEWDATA_32 || "没有指定视图ID[VIEWID]");
return;
}
}catch(error){
Ext.Msg.alert("metaviewdata.createfromexcel:" + error.message);
}
wcm.domain.MetaViewDataMgr.download("/wcm/app/metaviewdata/read_excel.jsp?ViewId=" + _nViewId);
},
download : function(sURL){
var frm = $MsgCenter.getActualTop().$('iframe4download');
if(frm == null) {
frm = $MsgCenter.getActualTop().document.createElement('IFRAME');
frm.id = "iframe4download";
frm.style.display = 'none';
$MsgCenter.getActualTop().document.body.appendChild(frm);
}
frm.src = sURL;
},
'import' : function(event){
var host = event.getHost();
var hostid = host.getId();
var _nViewId = event.getContext().params["VIEWID"];
try{
if(!_nViewId){
Ext.Msg.alert(wcm.LANG.METAVIEWDATA_32 || "没有指定视图ID[VIEWID]");
return;
}
}catch(error){
Ext.Msg.alert("metaviewdata.import:" + error.message);
}
var oParams = {
ViewId : _nViewId,
ChannelId : host.getType()=="website"?0:hostid
}
FloatPanel.open( WCMConstants.WCM6_PATH + 'metaviewdata/view_data_import.jsp?' + $toQueryStr(oParams), (wcm.LANG.METAVIEWDATA_35 || '导入记录'), CMSObj.afteradd(event));
},
quote : function(event){
var _nchannelId = event.getObjs().getAt(0).getPropertyAsInt("currchnlid");
var _sDocIds = event.getIds().join(',');
var oPostData = {
'channelids' : _nchannelId,
'objectids' : _sDocIds
}
FloatPanel.open( WCMConstants.WCM6_PATH + 'metaviewdata/record_quoteto.html?' + $toQueryStr(oPostData), (wcm.LANG.METAVIEWDATA_36 || '引用记录'), CMSObj.afteredit(event));
},
copy : function(event){
var _nchannelId = event.getObjs().getAt(0).getPropertyAsInt("currchnlid");
var _sDocIds = event.getIds().join(',');
var oPostData = {
'channelids' : _nchannelId,
'objectids' : _sDocIds
}
FloatPanel.open( WCMConstants.WCM6_PATH + 'metaviewdata/record_copyto.html?' + $toQueryStr(oPostData), (wcm.LANG.METAVIEWDATA_38 || '复制记录'), CMSObj.afteredit(event));
},
move : function(event){
var _nchannelId = event.getObjs().getAt(0).getPropertyAsInt("currchnlid");
var _sDocIds = event.getIds().join(',');
var oPostData = {
'channelids' : _nchannelId,
'objectids' : _sDocIds
}
FloatPanel.open( WCMConstants.WCM6_PATH + 'metaviewdata/record_moveto.html?' + $toQueryStr(oPostData), (wcm.LANG.METAVIEWDATA_39 || '移动记录'), CMSObj.afteredit(event));
},
add : function(event){
_addEdit(0,event);
},
edit : function(event){
var obj = event.getObj();
_addEdit(obj.getProperty("docid")||obj.getId(),event);
},
batchupdate : function(event){
var objIds = event.getContext().params["IDS"];
alert(objIds.split(",").length);
if(objIds.split(",").length > 5){
alert(wcm.LANG.metaviewdata_1001 || "要批量修改的数据超过了5个，为减少出错机会和减少对数据库的影响，请分批进行批量修改");
}
var _nViewId = event.getContext().params["VIEWID"];
var oPostData = {
'updateids' : objIds,
'viewid' : _nViewId
};
FloatPanel.open( WCMConstants.WCM6_PATH + 'metaviewdata/batchUpdate.jsp?' + $toQueryStr(oPostData), ('批量修改'), CMSObj.afteredit(event));
},
deleteEntity : function(event){
var sIds = event.getIds();
var nChnlId = event.getObj().getProperty("chnlId");
var oPageParams = {};
Ext.Msg.confirm(String.format("确实要将这{0}条记录放入废稿箱吗?",sIds.length), {
yes : function(){
ProcessBar.init(wcm.LANG.METAVIEWDATA_28 || '删除进度');
ProcessBar.addState((wcm.LANG.METAVIEWDATA_29 || '删除'), 2);
ProcessBar.start();
Object.extend(oPageParams,{"ObjectIds":sIds.join(","),"ChannelId":nChnlId});
BasicDataHelper.call('wcm6_document',"delete",oPageParams,true,function(transport, json){
ProcessBar.close();
var bSucess = $v(json, 'REPORTS.IS_SUCCESS') || true;
if(bSucess == false || bSucess == 'false'){
Ext.Msg.fault({
message : wcm.LANG.METAVIEWDATA_30 || '删除数据结果',
detail : json
});
}
event.getObjs().afterdelete();
});
}
});
},
exportall : function(event){
Ext.Msg.confirm(wcm.LANG.METAVIEWDATA_111 || '此操作可能需要较长时间。确实要导出所有记录吗？', {
yes : function(){
var _nViewId = event.getContext().params["VIEWID"];
var _nChnlId = event.getContext().params["CHANNELID"]
try{
if(!_nViewId){
Ext.Msg.alert(wcm.LANG.METAVIEWDATA_32 || "没有指定视图ID[VIEWID]");
return;
}
}catch(error){
Ext.Msg.alert("metaviewdata.export:" + error.message);
}
FloatPanel.open( WCMConstants.WCM6_PATH +'metaviewdata/record_export.jsp?' + $toQueryStr({
channelid : _nChnlId,
exportall : 1
}), (wcm.LANG.METAVIEWDATA_110 || '导出所有记录'), CMSObj.afteredit(event));
return;
}
});
},
setright : function(event){
var docId = event.getObj().getPropertyAsInt('docid', 0);
$openCenterWin(WCMConstants.WCM6_PATH + "auth/right_set.jsp?ObjType=605&ObjId=" + docId,
"document_right_set", 900, 600, "resizable=yes");
},
relationProMaintain : function(event){
var docId = event.getObj().getPropertyAsInt('docid', 0);
var currViewId = event.getObj().getPropertyAsInt("viewid",0)||contextParams.VIEWID||0;
wcm.MetaViewSelector.selectView({methodname : 'queryRelatingViews', MetaViewId:currViewId, ContainsChildrenBox : false},function(args){
var viewId = args.ViewId || 0;
var viewName = args.selectedNames;
if(viewId == 0)
return;
var url = WCMConstants.WCM6_PATH + 'metaviewdata/metaviewdata_relations_back_select.jsp?ViewName=' + encodeURIComponent(viewName);
FloatPanel.open({
src : url,
title : String.format("{0}数据管理",viewName),
callback : function(){
},
dialogArguments : {
relations : 0,
CurrDocId : 0,
RelatedDocId : docId,
FromBackSelect : true,
RelatingViewId : viewId,
RelatedViewId : currViewId
}
});
});
}
});
})();
function $openCenterWin(_sUrl, _sName, _width, _height, _sFeature){
if(!_width || !_height){
$openCentralWin(_sUrl, _sName);
return;
}
var _WIN_WIDTH = window.screen.availWidth;
var _WIN_HEIGHT = window.screen.availHeight;
var l = (_WIN_WIDTH - _width) / 2;
var t = (_WIN_HEIGHT - _height) / 2;
sFeature = "left="+l + ",top=" + t +",width=" 
+ _width + ",height=" + _height + "," + _sFeature;
var sName = _sName || "";
sName = sName.replace(/[^0-9a-zA-Z_]/g,'_');
var oWin = window.open(_sUrl, sName, sFeature);
if(oWin) oWin.focus();
}
function preparePostData(event){
return {
'objectids' : event.getIds(),
'channelids' : event.getObj().getPropertyAsInt('channelid')
};
}
function publish(event, _sMethodName){
var objectids = event.getIds().join(',');
var oPostData = {'ObjectIds' : objectids};
BasicDataHelper.call("wcm6_viewdocument", _sMethodName, oPostData, true,
function(_transport,_json){
wcm.domain.PublishAndPreviewMgr.doAfterPublish(oPostData, _sMethodName, _transport, _json);
}
);
}
(function(){
var pageObjMgr = wcm.domain.MetaViewDataMgr;
var reg = wcm.SysOpers.register;
function fnIsNotDraft(event){
var obj = event.getObj();
var bDraft= obj.getPropertyAsString("bDraft");
if("true" == bDraft){
return false;
}
return true;
}
reg({
key : 'docpositionset',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_40 || '改变记录顺序到',
title : wcm.LANG.METAVIEWDATA_40 || '改变记录顺序到...',
rightIndex : 62,
order : 1,
fn : pageObjMgr['docpositionset']
});
reg({
key : 'edit',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_41 || '修改这条记录',
title : wcm.LANG.METAVIEWDATA_41 || '修改这条记录...',
rightIndex : 32,
order : 2,
fn : pageObjMgr['edit'],
quickKey : 'E'
});
reg({
key : 'maintainreldoc',
type : 'MetaViewData',
desc : '维护关联产品',
title : '维护关联产品...',
rightIndex : 32,
order : 2.1,
fn : pageObjMgr['relationProMaintain'],
isVisible : function(event){
var contextParam = event.getContext().params;
var bShowRelDocsMaintain = contextParam['ShowRelDocsMaintain'];
if(!bShowRelDocsMaintain){
return false;
}else{
return true;
}
}
});
reg({
key : 'preview',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_42 || '预览这条记录',
title : wcm.LANG.METAVIEWDATA_43 || '预览这条记录发布效果',
rightIndex : 38,
order : 3,
fn : pageObjMgr['preview'],
quickKey : 'R'
});
reg({
key : 'basicpublish',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_44 || '发布这条记录',
title : wcm.LANG.METAVIEWDATA_45 || '发布这条记录，生成这条记录的细览页面以及更新相关概览页面',
rightIndex : 39,
order : 4,
isVisible : fnIsNotDraft,
fn : pageObjMgr['basicpublish'],
quickKey : 'P'
});
reg({
key : 'detailpublish',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_46 || '仅发布这条记录细览',
title : wcm.LANG.METAVIEWDATA_47 || '仅发布这条记录细览，仅重新生成这条记录的细览页面',
rightIndex : 39,
order : 5,
isVisible : fnIsNotDraft,
fn : pageObjMgr['detailpublish']
});
reg({
key : 'directpublish',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_131 || '直接发布这条记录',
title : wcm.LANG.METAVIEWDATA_132 || '发布这条记录细览，同时发布此记录的所有引用记录',
rightIndex : 39,
order : 5,
isVisible : fnIsNotDraft,
fn : pageObjMgr['directpublish']
});
reg({
key : 'recallpublish',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_48 || '撤销发布这条记录',
title : wcm.LANG.METAVIEWDATA_49 || '撤销发布这条记录，撤回已发布目录或页面',
rightIndex : 39,
order : 6,
isVisible : fnIsNotDraft,
fn : pageObjMgr['recallpublish']
});
reg({
key : 'directRecallpublish',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_133 || '直接撤销发布这条记录',
title : wcm.LANG.METAVIEWDATA_134 || '撤销发布这条记录，同步撤销这条记录所有的引用记录',
rightIndex : 39,
order : 6,
isVisible : fnIsNotDraft,
fn : pageObjMgr['directRecallpublish']
});
reg({
key : 'export',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_50 || '导出这条记录',
title : wcm.LANG.METAVIEWDATA_51 || '将这条记录导出成zip文件',
rightIndex : 34,
order : 7,
fn : pageObjMgr['export'],
quickKey : 'X'
});
reg({
key : 'seperate',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_52 || '分隔线',
title : wcm.LANG.METAVIEWDATA_52 || '分隔线',
rightIndex : -1,
order : 8,
fn : pageObjMgr['seperate']
});
reg({
key : 'changestatus',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_53 || '改变这条记录状态',
title : wcm.LANG.METAVIEWDATA_53 || '改变这条记录状态',
rightIndex : 35,
order : 9,
isVisible : fnIsNotDraft,
fn : pageObjMgr['changestatus']
});
reg({
key : 'changelevel',
type : 'MetaViewData',
desc : '改变这条记录的密级',
rightIndex : 61,
order : 9,
fn : pageObjMgr['changelevel']
});
reg({
key : 'move',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_54 || '移动这条记录到',
title : wcm.LANG.METAVIEWDATA_54 || '移动这条记录到',
rightIndex : 33,
order : 10,
isVisible : fnIsNotDraft,
fn : pageObjMgr['move']
});
reg({
key : 'copy',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_55 || '复制这条记录到',
title : wcm.LANG.METAVIEWDATA_55 || '复制这条记录到',
rightIndex : 34,
order : 11,
isVisible : fnIsNotDraft,
fn : pageObjMgr['copy']
});
reg({
key : 'quote',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_56 || '引用这条记录到',
title : wcm.LANG.METAVIEWDATA_56 || '引用这条记录到',
rightIndex : 34,
order : 12,
isVisible : fnIsNotDraft,
fn : pageObjMgr['quote']
});
reg({
key : 'delete',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_129 || '删除记录',
title : wcm.LANG.METAVIEWDATA_57 || '将记录放入废稿箱',
rightIndex : 33,
order : 13,
fn : pageObjMgr['delete'],
quickKey : ['Delete', 'ShiftDelete']
});
reg({
key : 'add',
type : 'MetaViewDataInChannel',
desc : '新建一条记录',
title : '新建一条记录...',
rightIndex : 31,
order : 14,
fn : pageObjMgr['add'],
quickKey : 'N'
});
reg({
key : 'import',
type : 'MetaViewDataInChannel',
desc : wcm.LANG.METAVIEWDATA_59 || '从外部导入记录',
title : wcm.LANG.METAVIEWDATA_59 || '从外部导入记录...',
rightIndex : 31,
order : 15,
fn : pageObjMgr['import']
});
reg({
key : 'createfromexcel',
type : 'MetaViewDataInChannel',
desc : wcm.LANG.METAVIEWDATA_60 || '从Excel创建记录',
title : wcm.LANG.METAVIEWDATA_60 || '从Excel创建记录...',
rightIndex : 31,
order : 16,
fn : pageObjMgr['createfromexcel']
});
reg({
key : 'setsynrule',
type : 'MetaViewDataInChannel',
desc : wcm.LANG.METAVIEWDATA_61 || '设置同步规则',
title : wcm.LANG.METAVIEWDATA_62 || '设置同步到文档的规则',
rightIndex : 13,
order : 17,
fn : pageObjMgr['setsynrule']
});
reg({
key : 'preview',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_63 || '预览这些记录',
title : wcm.LANG.METAVIEWDATA_64 || '预览这些记录发布效果',
rightIndex : 38,
order : 18,
fn : pageObjMgr['preview'],
quickKey : 'R'
});
reg({
key : 'basicpublish',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_65 || '发布这些记录',
title : wcm.LANG.METAVIEWDATA_66 || '发布这些记录，生成这些记录的细览页面以及更新相关概览页面',
rightIndex : 39,
order : 19,
fn : pageObjMgr['basicpublish'],
quickKey : 'P'
});
reg({
key : 'detailpublish',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_67 || '仅发布这些记录细览',
title : wcm.LANG.METAVIEWDATA_68 || '仅发布这些记录细览，仅重新生成这些记录的细览页面',
rightIndex : 39,
order : 20,
fn : pageObjMgr['detailpublish']
});
reg({
key : 'directpublish',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_135 || '直接发布这些记录',
title : wcm.LANG.METAVIEWDATA_136 || '发布这些记录细览，同时发布这些记录的所有引用记录',
rightIndex : 39,
order : 20,
fn : pageObjMgr['directpublish']
});
reg({
key : 'recallpublish',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_69 || '撤销发布这些记录',
title : wcm.LANG.METAVIEWDATA_70 || '撤销发布这些记录，撤回已发布目录或页面',
rightIndex : 39,
order : 21,
fn : pageObjMgr['recallpublish']
});
reg({
key : 'directRecallpublish',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_137 || '直接撤销发布这些记录',
title : wcm.LANG.METAVIEWDATA_138 || '撤销发布这些记录，同步撤销这些记录所有的引用记录',
rightIndex : 39,
order : 21,
fn : pageObjMgr['directRecallpublish']
});
reg({
key : 'export',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_71 || '导出这些记录',
title : wcm.LANG.METAVIEWDATA_72 || '将这些记录导出成zip文件',
rightIndex : 34,
order : 22,
fn : pageObjMgr['export']
});
reg({
key : 'seperate',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_52 || '分隔线',
title : wcm.LANG.METAVIEWDATA_52 || '分隔线',
rightIndex : -1,
order : 23,
fn : pageObjMgr['seperate']
});
reg({
key : 'changestatus',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_73 || '改变这些记录状态',
title : wcm.LANG.METAVIEWDATA_73 || '改变这些记录状态',
rightIndex : 35,
order : 24,
fn : pageObjMgr['changestatus']
});
reg({
key : 'changelevel',
type : 'MetaViewDatas',
desc : '改变这些记录的密级',
rightIndex : 61,
order : 25,
fn : pageObjMgr['changelevel']
});
reg({
key : 'move',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_74 || '移动这些记录到',
title : wcm.LANG.METAVIEWDATA_74 || '移动这些记录到',
rightIndex : 33,
order : 25,
fn : pageObjMgr['move']
});
reg({
key : 'copy',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_75 || '复制这些记录到',
title : wcm.LANG.METAVIEWDATA_75 || '复制这些记录到',
rightIndex : 34,
order : 26,
fn : pageObjMgr['copy']
});
reg({
key : 'quote',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_76 || '引用这些记录到',
title : wcm.LANG.METAVIEWDATA_76 || '引用这些记录到',
rightIndex : 34,
order : 27,
fn : pageObjMgr['quote']
});
reg({
key : 'delete',
type : 'MetaViewDatas',
desc : wcm.LANG.METAVIEWDATA_129 || '删除记录',
title : wcm.LANG.METAVIEWDATA_57 || '将记录放入废稿箱',
rightIndex : 33,
order : 28,
fn : pageObjMgr['delete'],
quickKey : ['Delete', 'ShiftDelete']
});
reg({
key : 'setright',
type : 'MetaViewData',
desc : wcm.LANG.METAVIEWDATA_117 || '设置这条记录权限',
title : wcm.LANG.METAVIEWDATA_117 || '设置这条记录权限',
rightIndex : 61,
order : 14,
fn : pageObjMgr['setright']
});
reg({
key : 'exportall',
type : 'MetaViewDataInChannel',
desc : wcm.LANG.METAVIEWDATA_110 || '导出所有记录',
title : wcm.LANG.METAVIEWDATA_110 || '导出所有记录...',
rightIndex : 34,
order : 29,
fn : pageObjMgr['exportall']
});
})();

Ext.ns('wcm.MetaViewDatas', 'wcm.MetaViewData');
WCMConstants.OBJ_TYPE_METAVIEWDATA = 'MetaViewData';
wcm.MetaViewDatas = function(_config, _context){
this.objType = WCMConstants.OBJ_TYPE_METAVIEWDATA;
wcm.MetaViewDatas.superclass.constructor.call(this, _config, _context);
}
Ext.extend(wcm.MetaViewDatas, wcm.CMSObjs, {
});
wcm.MetaViewData = function(_config, _context){
this.objType = WCMConstants.OBJ_TYPE_METAVIEWDATA;
wcm.MetaViewData.superclass.constructor.call(this, _config, _context);
var arrRights = {
"view" : -1
};
for(rightName in arrRights){
var cameRightName = rightName.camelize();
var nRightIndex = parseInt(arrRights[rightName], 10);
this['can'+cameRightName] = function(){
return wcm.AuthServer.hasRight(this.right, nRightIndex);
}
}
}
CMSObj.register(WCMConstants.OBJ_TYPE_METAVIEWDATA, 'wcm.MetaViewData');
Ext.extend(wcm.MetaViewData, wcm.CMSObj, {
});

(function(){
var sName = wcm.LANG['METAVIEWDATA'] || '资源';
wcm.PageOper.registerPanels({
metaviewdataInRoot : {
isHost : true,
title : String.format(wcm.LANG['OPER_TITLE_INROOT'] || '库{0}操作任务', sName),
displayNum : 5
},
metaviewdataInSite : {
isHost : true,
title : String.format(wcm.LANG['OPER_TITLE_INSITE'] || '站点{0}操作任务', sName),
displayNum : 5
},
metaviewdataInChannel : {
isHost : true,
title : String.format(wcm.LANG['OPER_TITLE_INCHANNEL'] || '栏目{0}操作任务', sName),
displayNum : 5
},
metaviewdata : {
title : String.format(wcm.LANG['OPER_TITLE_OBJ'] || '{0}操作任务', sName),
displayNum : 7,
url : '?serviceid=wcm61_metaviewdata&methodname=findById'
},
metaviewdatas : {
title : String.format(wcm.LANG['OPER_TITLE_OBJ'] || '{0}操作任务', sName),
displayNum : 7
}
});
})();

Ext.ns('wcm.domain.MetaViewDataMgr');
(function(){
Ext.apply(wcm.domain.MetaViewDataMgr, {
showCrashBoard : function(event){
var currObj = event.getObj();
var nRecId = currObj.getPropertyAsInt('recid');//获取文档的ChnlDocId
var nStatusId = currObj.getPropertyAsInt('docstatusId');
if(nStatusId != 10){
var sDocTitle = currObj.getPropertyAsString('doctitle');
alert('抱歉，文档还未发布！请确认文档已审核通过并且发布！\n文档标题：' + sDocTitle);
return;
}
var cbId = 'SCMCrashBoard';
var crashboard = wcmXCom.get(cbId);
if(!crashboard){
crashboard = new wcm.CrashBoard({
id: cbId,
title:'从WCM创建微博',
maskable:true, 
draggable : true,
width : '574px',//宽度
height : '415px',//高度
params : {RecId:nRecId,SCMGroupId:0,SiteType:4},
src: WCMConstants.WCM6_PATH + 'scm/create_microblog_wcm.jsp',//内嵌页面地址
callback : function(params){
var patt = new RegExp('非常抱歉');//要查找的字符串
if(patt.test(params)){
return;
}
var oHelper = new com.trs.web2frame.BasicDataHelper();
oHelper.Call(
'wcm61_scmmicrocontent', 
'save', 
{AccountIds:params._AccountIds, SCMGroupId:params._SCMGroupId, Content:params._MicroContent, Picture:params._Picture,Source:params._Source},
true,
function(){
if(params._hasWorkFlow == '1'){
alert("微博已提交审核人员，请您耐心等待审核结果。");
}else{
alert("已提交发布队列，请您稍后，即刻发布微博！");
}
this.close();
},
function(_transport,_json){$render500Err(_transport,_json);this.close();},
function(_transport,_json){}
);
}
});
crashboard.show();
}
}
} )
})();
(function(){
var fnIsVisible = function(event){
var currObj = event.getObj();
var nStatusId = currObj.getPropertyAsInt('docstatusId');
if(nStatusId == 10){
if($MsgCenter.getActualTop().g_IsRegister['SCM']){
var transport = ajaxRequest({
url : WCMConstants.WCM_ROOTPATH + 'center.do?serviceid=wcm61_scmgroup&methodname=isAdminsOfSCMGroups',
method : 'GET',
parameters : '',
asyn : false
});
if(transport != undefined && transport != null){
var json = parseXml(loadXml(transport.responseText));
return $a(json, "result") == 'true';
}
}
}
return false;
};
var reg = wcm.SysOpers.register;
reg({
key : 'createmicrocontentinfo', //唯一标识该操作
type : 'MetaViewData', //操作面板的类型参考《TRSWCM6.5二次开发-操作面板》
desc : '发布一条微博', //操作的显示名称
title : '发布一条微博', //操作的提示信息
order : 3.1,
fn : wcm.domain.MetaViewDataMgr['showCrashBoard'], //调用在上面定义的方法
isVisible : fnIsVisible
});
})();


(function(){
Ext.apply(wcm.domain.MetaViewDataMgr, {
settopdocumentforever : function(event){
cb = new wcm.CrashBoard({
title : wcm.LANG.DOCUMENT_PROCESS_276||'置顶设置',
src : WCMConstants.WCM6_PATH+'document/document_settopforever.jsp',
width:'600px',
height:'310px',
maskable:true,
appendParamsToUrl : true,
params : {
DocumentId : event.getObj().docid,
ChannelId : event.getObj().getPropertyAsInt('currchnlid')
},
callback : function(oPostData) {
var oHelper = new com.trs.web2frame.BasicDataHelper();
oHelper.Call("wcm6_document", "settopdocument", oPostData, true,
function(_transport,_json){
event.getObjs().afteredit();
});
this.close();
}
});
cb.show();
},
settopdocumentquit : function(event){
var sDocId = event.getObj().docid;
var nChnlId = event.getObj().getPropertyAsInt('currchnlid');
var oPostData = {
channelid : nChnlId,
documentid : sDocId,
targetdocumentid : 0,
topflag : 0
};
var oHelper = new com.trs.web2frame.BasicDataHelper();
oHelper.Call("wcm6_document", "settopdocument", oPostData, true,
function(_transport,_json){
event.getObjs().afteredit();;
});
}
});
})();
(function(){
var pageObjMgr = wcm.domain.MetaViewDataMgr;
var reg = wcm.SysOpers.register;
var fnIsVisible = function(event){
var host = event.getHost();
if(host.getType()==WCMConstants.OBJ_TYPE_WEBSITE){
return false;
}
return true;
};
reg({
key : 'settopdocumentforever',
type : 'MetaViewData',
desc : wcm.LANG.DOCUMENT_PROCESS_276||'置顶设置',
title : '置顶设置...',
rightIndex : 62,
order : 16.5,
fn : pageObjMgr['settopdocumentforever'],
isVisible : fnIsVisible
});
reg({
key : 'settopdocumentquit',
type : 'MetaViewData',
desc : wcm.LANG.DOCUMENT_PROCESS_232 ||'取消置顶',
title : '取消置顶...',
rightIndex : 62,
order : 16,
fn : pageObjMgr['settopdocumentquit'],
isVisible : function(event){
var docContext = event.getObj();
if(docContext.getPropertyAsString("isTopped") == "true") {
return true;
} else {
return false;
}
}
});
})();

