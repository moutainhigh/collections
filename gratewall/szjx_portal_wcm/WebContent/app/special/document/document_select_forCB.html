<HTML xmlns:TRS_UI>
<HEAD>
	<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<TITLE WCMAnt:param="link_document_select.html.selectLinkDocument">选择链接文档</TITLE>
	<!--css-->
    <link href="../../js/resource/widget.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../css/wcm-common.css">
    <link rel="stylesheet" type="text/css" href="../../css/wcm-list-common.css">

	<script src="../../js/runtime/myext-debug.js"></script>
	<script src="../../js/source/wcmlib/WCMConstants.js"></script>
	<script src="../../js/data/locale/document.js"></script>
	<script src="../../js/source/wcmlib/core/MsgCenter.js"></script>
	<script src="../../js/source/wcmlib/core/CMSObj.js"></script>
	<SCRIPT src="../../js/source/wcmlib/Observable.js"></SCRIPT>
	<!--AJAX-->
	<script src="../../js/source/wcmlib/com.trs.web2frame/AjaxRequest.js"></script>
	<script language="javascript">
		//从上下文中获取参数。
		var CurrChannelId = getParameter("DocChannelId");
		var PRV_OBJ_TYPE_CHNLDOC = "ChnlDoc_Relation";
		var PRV_OBJ_TYPE_DOCUMENT = "Document_Relation";
		var PRV_OBJ_TYPE_CURRPAGE = "CurrPage_Relation";
	</script>
	<style type="text/css">
		body {
			padding-top:0px;
			background-color: white;
			border:1px solid #acddfd;
		}
	</style>
	<script language="javascript">
	<!--
		$MsgCenter.on({
			objType : WCMConstants.OBJ_TYPE_TREENODE,
			afterclick : function(event){
				//负责导航树对应的页面切换
				var context = event.getContext();
				var objId = context.objId;
				var objType = context.objType;
				var sParams = '';
				var sHostType = mappingHostWithObjType(objType);
				var mySrc = '../../document/document_select_list.html';
				switch(objType){
					case WCMConstants.OBJ_TYPE_WEBSITEROOT:
						return false;
					case WCMConstants.OBJ_TYPE_WEBSITE:
						sParams = '&SiteId=' + objId;
						sParams += '&SiteType=' + context.siteType;
						break;
					case WCMConstants.OBJ_TYPE_CHANNEL:
						sParams = '&ChannelId=' + objId;
						sParams += '&SiteType=' + context.siteType;
						sParams += '&IsVirtual=' + context.isVirtual;
						sParams += '&ChannelType=' + context.channelType;
						break;
				}
				sParams += '&RightValue=' + context.right;
				sParams += '&selectType=' + getParameter('selectType');
		//		sParams += '&' + $('FieldName').value + '=' + $('SearchWord').value;
				$('channel_doc_list').src = mySrc + '?' + sParams;
				return false;
			}
		});
		$MsgCenter.on({
			objType : PRV_OBJ_TYPE_CURRPAGE,
			afterinit : function(event){
				if(event.from()==wcm.getMyFlag())return;
				var objs = CMSObj.createEnumsFrom({
					objType : PRV_OBJ_TYPE_CHNLDOC
				});
				for(var i=0, n=defaultSelect.length; i<n; i++){
					objs.addElement(CMSObj.createFrom({
						objId : defaultSelect[i],
						objType : PRV_OBJ_TYPE_CHNLDOC
					}));
				}
				objs.afterselect();
			}
		});
		$MsgCenter.on({
			objType : PRV_OBJ_TYPE_CHNLDOC,
			afterselect : function(event){
				if(event.from()==wcm.getMyFlag())return;
				var obj = event.getObjs().getAt(0);
				if(obj==null)return;
				AddSelectedDoc(obj.getId(), {
					recId : obj.getId(), 
					docId : obj.getPropertyAsInt('docid', 0), 
					docTitle : obj.getProperty('docTitle')
				});
				defaultSelect.push(obj.getId());
			},
			afterunselect : function(event){
				var obj = event.getObjs().getAt(0);
				if(obj==null)return;
				RemoveSelectedDoc(obj.getId());
				defaultSelect.remove(obj.getId());
			}
		});
		var hsSelectedInfo = {};
		var defaultSelect = [];
		var recIds = getParameter('recIds');
		if(recIds && recIds != "0"){
			defaultSelect = recIds.split(",");
		}
		function mappingHostWithObjType(objType){
			switch(objType){
				case WCMConstants.OBJ_TYPE_WEBSITEROOT:
					return WCMConstants.TAB_HOST_TYPE_WEBSITEROOT;
				case WCMConstants.OBJ_TYPE_WEBSITE:
					return WCMConstants.TAB_HOST_TYPE_WEBSITE;
				case WCMConstants.OBJ_TYPE_CHANNEL:
					return WCMConstants.TAB_HOST_TYPE_CHANNEL;
				case WCMConstants.OBJ_TYPE_MYFLOWDOCLIST:
					return WCMConstants.TAB_HOST_TYPE_MYFLOWDOCLIST;
				case WCMConstants.OBJ_TYPE_MYMSGLIST:
					return WCMConstants.TAB_HOST_TYPE_MYMSGLIST;
			}
		}
		function AddSelectedDoc(_nRecId, infos){
			hsSelectedInfo[_nRecId] = infos;
		}
		function RemoveSelectedDoc(_nRecId){
			delete hsSelectedInfo[_nRecId];
		}

		window.m_cbCfg = {
			btns : [
				{
					text : '保存',
					cmd : function(){
						//关闭窗口，并返回选中文档的Id序列
						this.notify({ids:defaultSelect, infos:hsSelectedInfo});
						this.hide();
						return false;
					}
				},
				{
					extraCls : 'wcm-btn-close',
					text : '关闭'
				}
			]
		};

	</script>
</HEAD>
<BODY>
		<TABLE style="table-layout:fixed;">
			<TR>
				<TD width="200" height="385" valign="top">
					<iframe src="../../include/blank.html" id="treeNav" allowtransparency="true" scrolling="no" frameborder="0"></iframe>
				</TD>
				<td width="585" height="385" valign="top">
					<iframe id='channel_doc_list' src="../../include/blank.html" allowtransparency="true" scrolling="no" frameborder="0"></iframe>
				</TD>
			</TR>
		</TABLE>
<script>
	Event.observe(window, 'load', function(){
		$('treeNav').src = '../../nav_tree/nav_tree_inner.html?siteTypes=0,4&ChannelId='+CurrChannelId;;
	});
	function doSearch(){
		var oPostData = Ext.Json.toUpperCase($('channel_doc_list').src.parseQuery());
		var selFieldName = $('FieldName');
		var sFieldName = selFieldName.value;
		for (var i = 0; i < selFieldName.options.length; i++){
			delete oPostData[selFieldName.options[i].value.toUpperCase()];
		}
		oPostData[sFieldName] = $('SearchWord').value;
		$('channel_doc_list').src = '../../document/document_select_list.html?' + $toQueryStr(oPostData);
	}
</script>
</BODY>
</HTML>