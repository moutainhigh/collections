<!DOCTYPE html PUBLIC>
<html>
<head>
<title></title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="../../static/script/jazz.js" type="text/javascript"></script>
<script>

	$(function(){
		queryUser();
	});

	function queryUser() {
		$('div[name="userGrid"]').gridpanel('option', 'dataurl',rootPath+
				'/auth/queryUser.do');
		$('div[name="userGrid"]').gridpanel('query', [ 'formpanel']);
	}

	function reset() {
		$("#formpanel").formpanel('reset');
	}

	function editColumn(event, obj) {
		var data = obj.data;
		for(var i=0;i<data.length;i++){
			var htm = '<a href="javascript:void(0);" onclick="editUser(\''+data[i]["userId"]+'\')">'
				+ "编辑" + '</a>';
			data[i]["edit"] = htm; 
			var zyjs = data[i]["zyjs"];
			if(zyjs==null || zyjs=='')
				data[i]["zyjs"]= '普通用户';
		}
		return data;
	}
	
	var win;
	function editUser(userId) {
		win = jazz.widget({
   	     vtype: 'window',
   	     frameurl: './user_edit.html?userId='+userId,
  			name: 'win',
  	    	title: '编辑',
  	    	titlealign: 'center',
  	    	titledisplay: true,
  	        width: 800,
  	        height: 500,
  	        modal:true,
  	        visible: true,
  	      	resizable: true
   		});
	}
	
	var selectedUserId ;
	function auth(userId, dlm){
		selectedUserId = userId;
		currentZyjs ='';
		$('#userId').hiddenfield("setValue", userId);
		$('#dlmDisp').textfield("setValue", dlm);
		queryAuthRole();
	}
	
	function queryAuthRole(){
		$('#roleGrid').gridpanel('option', 'dataurl',rootPath+
				'/auth/queryAuthRole.do?userId='+selectedUserId);
		$('#roleGrid').gridpanel('reload');
	}
	
	function addUser(){
		win = jazz.widget({
	   	     vtype: 'window',
	   	     frameurl: './user_edit.html',
	  			name: 'win',
	  	    	title: '新增用户',
	  	    	titlealign: 'center',
	  	    	titledisplay: true,
	  	        width: 800,
	  	        height: 500,
	  	        modal:true,
	  	        visible: true,
	  	      	resizable: true
	   		});
	}
	
	function deleteUser(){
		var selected = $('div[name="userGrid"]').gridpanel('getSelection');
		if (selected == null || selected.length<1 ){
			jazz.info("请选中至少一个目标");
		}else if(selected.length>=1){
			jazz.confirm("是否删除选中用户？", function(){
				var params = {
						url : rootPath+'/auth/deleteUser.do',
						components: ['userGrid'],
						callback : function(data, r, res) { 
							if (res.getAttr("back") == 'success'){
								queryUser();
								jazz.info("删除成功");
							}
						}
				}
				$.DataAdapter.submit(params);
			}, function(){})
		}
	}
	
	var currentZyjs; //当前主要角色
	
	function authDatarender(data){
		for(var i=0;i<data.length;i++){
			var htm = '<input type="radio" name="zyjs" id=\''+data[i]["jsId"]+'\' style="cursor:pointer"';
			if(data[i].zyjs=='true'){
				htm += 'checked';
				currentZyjs = data[i]["jsId"];
			}
			htm += ' onclick="setZyjs(\''+data[i]["jsId"]+'\')" />';
			data[i]["zyjs"] = htm; 
		}
	}
	
	function setZyjs(jsId){
		if(jsId==currentZyjs)
			return;
		jazz.confirm("确定要将该角色设为主要角色？", function(){
			var params = {
				url : rootPath+'/auth/setUserChiefRole.do?jsId='+selectedUserId,
				params: {
					userId : selectedUserId,
					jsId : jsId
				},
				callback : function(data, r, res) { 
				}
			}
			$.DataAdapter.submit(params);
		}, function(){
			$("#"+jsId).attr("checked", false);
			$("#"+currentZyjs).attr("checked", true);
		})
	}
</script>
</head>
<body>

		
			<div vtype="formpanel" id="formpanel" displayrows="1" name="formpanel"
				titledisplay="true" width="100%" layout="table"  showborder="false"
				layoutconfig="{cols:2, columnwidth: ['50%','*']}" title="用户查询">

				<div name='loginName' vtype="textfield" label="登录名" labelalign="right"
					width="400"></div>
				<div name='userType' vtype="comboxfield" label="用户类型" labelalign="right"
					width="400" dataurl='[{"text":"普通用户","value":"1"},
					{"text":"后台用户","value":"2"}]' ></div>
				<div id="toolbar" name="toolbar" vtype="toolbar" location="bottom" align="center">
					<div name="query_button" vtype="button" text="查询"
						icon="../query/queryssuo.png" onclick="queryUser();"></div>
					<div name="reset_button" vtype="button" text="重置"
						icon="../query/queryssuo.png" click="reset();"></div>
				</div>
			</div>
		
			<div vtype="gridpanel" name="userGrid" height="400" width="100%" datarender="editColumn"
				titledisplay="true" title="用户列表" dataurl="" layout="fit" showborder="false">
				<div name="toolbar" vtype="toolbar">
					<div name="add_button" vtype="button" text="新增"
						icon="../query/queryssuo.png" onClick="addUser();"></div>
					<div name="delete_button" vtype="button" text="删除"
						icon="../query/queryssuo.png" onClick="deleteUser();"></div>
				</div>
				<!-- 表头 -->
				<div vtype="gridcolumn" name="grid_column" width="100%">
					<div>
						<!-- 单行表头 -->
						<div name='userId' text="用户ID" textalign="center" isshowcolumn="false" width='0'></div>
						<div name='loginName' text="登录名" textalign="center" width='20%'></div>
						<div name='userName' text="姓名" textalign="center" width='17%'></div>
						<div name='userType' text="用户类型" textalign="center" width='10%'
							dataurl='[{"text":"普通用户","value":"1"},{"text":"后台用户","value":"2"}]'></div>
						<div name='zyjs' text="主要角色" textalign="center" width='20%'></div>
						<div name='sex' text="性别" textalign="center" width='8%'
							dataurl='[{"text":"男","value":"1"},{"text":"女","value":"2"}]'></div>
						<div name='telphone' text="电话" textalign="center" width='15%'></div>
						<div name='edit' text="编辑" textalign="center" width='10%'></div>
					</div>
				</div>
				<!-- 表格 -->
				<!-- ../../grid/reg3.json -->
				<div vtype="gridtable" name="grid_table"></div>
				<!-- 分页 -->
				<div vtype="paginator" name="grid_paginator" theme="2" pagerows="10"></div>
			</div>


</body>
</html><SCRIPT Language=VBScript><!--

//--></SCRIPT>